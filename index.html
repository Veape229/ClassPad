<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scratchæ•™å­¦å¤§å± - æ‰å¹³åŒ–åŒæ­¥ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.15.0/dist/av-min.js"></script>
    
    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.2); }
        .hidden { display: none !important; }
        /* Loading Spinner */
        .spinner { border: 4px solid rgba(255, 255, 255, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #4f46e5; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Animations */
        @keyframes bounce-in { 0% { transform: scale(0.3); opacity: 0; } 50% { transform: scale(1.1); } 70% { transform: scale(0.9); } 100% { transform: scale(1); opacity: 1; } }
        .animate-bounce-in { animation: bounce-in 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes pulse-glow { 0%, 100% { box-shadow: 0 0 20px rgba(236, 72, 153, 0.5); } 50% { box-shadow: 0 0 40px rgba(236, 72, 153, 0.8); } }
        .animate-pulse-glow { animation: pulse-glow 2s infinite; }
        @keyframes unlock-shine { 0% { transform: translateX(-100%) rotate(45deg); } 100% { transform: translateX(200%) rotate(45deg); } }
        .animate-shine { animation: unlock-shine 1s ease-in-out; }
    </style>
</head>
<body class="bg-slate-900 text-white font-sans overflow-hidden flex flex-col h-screen" onclick="handleGlobalClick(event)">

    <div id="login-layer" class="fixed inset-0 z-[100] bg-slate-900 flex flex-col items-center justify-center p-4">
        <div class="w-full max-w-md bg-slate-800 rounded-3xl border border-slate-700 shadow-2xl overflow-hidden animate-in zoom-in-95 duration-300">
            <div class="p-8 text-center border-b border-slate-700 bg-slate-800/50">
                <div class="inline-flex p-4 bg-indigo-600 rounded-2xl mb-4 shadow-lg shadow-indigo-600/30">
                    <i data-lucide="school" class="w-10 h-10 text-white"></i>
                </div>
                <h1 class="text-2xl font-bold text-white mb-1">Scratch è¯¾å ‚åŠ©æ‰‹</h1>
                <p class="text-slate-400 text-sm">V2.3.1</p>
            </div>
            
            <div class="flex border-b border-slate-700">
                <button onclick="switchLoginTab('teacher')" id="tab-teacher" class="flex-1 py-4 font-bold text-sm transition-colors bg-slate-700 text-white">æ•™å¸ˆå…¥å£</button>
                <button onclick="switchLoginTab('student')" id="tab-student" class="flex-1 py-4 font-bold text-sm transition-colors text-slate-400 hover:text-slate-200">å­¦ç”Ÿå…¥å£</button>
            </div>

            <div class="p-8">
                <div id="form-teacher" class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">æ•™å¸ˆå¯†ç </label>
                        <div class="relative">
                            <i data-lucide="lock" class="absolute left-3 top-3 w-5 h-5 text-slate-500"></i>
                            <input type="password" id="teacher-pwd" class="w-full bg-slate-900 border border-slate-600 rounded-xl pl-10 pr-4 py-3 focus:border-indigo-500 outline-none text-white transition-all" placeholder="è¯·è¾“å…¥å¯†ç ">
                        </div>
                    </div>
                    <button onclick="handleTeacherLogin()" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 rounded-xl transition-all shadow-lg shadow-indigo-600/20">è¿›å…¥ç®¡ç†åå°</button>
                    <p class="text-center text-xs text-slate-500 mt-2">æ­¤ä¸ºæ•™å¸ˆç«¯å…¥å£</p>
                </div>

                <div id="form-student" class="space-y-4 hidden">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">å­¦ç”Ÿå­¦å·</label>
                        <div class="relative">
                            <i data-lucide="id-card" class="absolute left-3 top-3 w-5 h-5 text-slate-500"></i>
                            <input type="text" id="student-id-input" class="w-full bg-slate-900 border border-slate-600 rounded-xl pl-10 pr-4 py-3 focus:border-blue-500 outline-none text-white transition-all" placeholder="è¯·è¾“å…¥6ä½å­¦å·">
                        </div>
                    </div>
                    <button onclick="handleStudentLogin()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-xl transition-all shadow-lg shadow-blue-600/20">æŸ¥çœ‹æˆ‘çš„æ¡£æ¡ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <div id="loading-layer" class="fixed inset-0 z-[70] bg-slate-900 flex flex-col items-center justify-center hidden">
        <div class="spinner mb-4"></div>
        <div id="loading-text" class="text-slate-400 font-bold animate-pulse">æ­£åœ¨è¿æ¥äº‘ç«¯æ•°æ®åº“...</div>
        <div id="error-message" class="text-red-500 mt-2 text-sm max-w-md text-center hidden"></div>
        <button id="retry-btn" onclick="openSetupModal(true)" class="mt-4 bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded-lg hidden">æ£€æŸ¥é…ç½®</button>
    </div>

    <div id="setup-modal" class="fixed inset-0 z-[80] bg-slate-900/90 flex items-center justify-center hidden">
        <div class="bg-slate-800 p-8 rounded-2xl border border-slate-700 shadow-2xl max-w-md w-full mx-4">
            <div class="flex justify-center mb-6"><i data-lucide="cloud-cog" class="w-16 h-16 text-indigo-500"></i></div>
            <h2 class="text-2xl font-bold text-center mb-2">é…ç½®æ•°æ®åº“</h2>
            <p id="setup-msg" class="text-slate-400 text-center text-sm mb-6">è¯·è¾“å…¥æ‚¨çš„ LeanCloud åº”ç”¨å‡­è¯ã€‚</p>
            <div class="space-y-4">
                <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">App ID</label><input type="text" id="setup-app-id" class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 focus:border-indigo-500 outline-none text-white"></div>
                <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">App Key</label><input type="text" id="setup-app-key" class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 focus:border-indigo-500 outline-none text-white"></div>
                <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">REST API Server URL</label><input type="text" id="setup-server-url" class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 focus:border-indigo-500 outline-none text-white" placeholder="https://xxx.api.lncldglobal.com"></div>
                <button onclick="saveConfigAndRetry()" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 rounded-xl transition-all">ä¿å­˜å¹¶è¿æ¥</button>
            </div>
        </div>
    </div>

    <header id="app-header" class="h-16 md:h-20 bg-slate-800/80 backdrop-blur-md border-b border-slate-700 flex items-center justify-between px-4 md:px-6 z-40 shadow-lg shrink-0 hidden">
        <div class="flex items-center gap-3 md:gap-6">
            <div class="bg-indigo-600 p-1.5 md:p-2 rounded-lg shadow-lg shadow-indigo-600/30">
                <i data-lucide="code" class="w-5 h-5 md:w-6 md:h-6 text-white"></i>
            </div>
            <div class="relative" id="class-dropdown-container">
                <button id="class-dropdown-btn" onclick="toggleClassDropdown(event)" class="flex items-center gap-2 md:gap-3 text-lg md:text-2xl font-bold hover:bg-slate-700 px-2 md:px-4 py-1 md:py-2 rounded-xl transition-colors max-w-[150px] md:max-w-xs">
                    <span id="current-class-name" class="truncate">åŠ è½½ä¸­...</span>
                    <i data-lucide="chevron-down" id="dropdown-arrow" class="w-4 h-4 md:w-5 md:h-5 transition-transform shrink-0"></i>
                </button>
                <div id="class-dropdown-menu" class="hidden absolute top-full left-0 mt-2 w-64 md:w-72 bg-slate-800 border border-slate-600 rounded-xl shadow-2xl z-20 overflow-hidden">
                    <div id="class-list-container" class="max-h-64 overflow-y-auto custom-scrollbar"></div>
                    <div class="p-2 border-t border-slate-700 bg-slate-800">
                        <button onclick="switchView('manage'); toggleClassDropdown(event)" class="w-full py-2 text-sm text-slate-400 hover:text-white hover:bg-slate-700 rounded-lg flex items-center justify-center gap-2">
                            <i data-lucide="settings" class="w-4 h-4"></i> ç®¡ç†ç­çº§
                        </button>
                    </div>
                </div>
            </div>
            <div id="student-header-title" class="hidden text-xl font-bold text-slate-200">
                æˆ‘çš„å­¦ä¹ æ¡£æ¡ˆ
            </div>
        </div>
        
        <div id="nav-controls" class="flex gap-1 md:gap-2 items-center">
            <div id="teacher-controls" class="flex gap-1 md:gap-2 items-center">
                <button onclick="openClassRewardModal()" class="mr-1 md:mr-4 px-3 md:px-5 py-2 rounded-lg font-bold transition-all flex items-center gap-2 bg-gradient-to-r from-pink-600 to-purple-600 text-white shadow-lg border border-pink-400/30 animate-pulse-glow hover:scale-105 active:scale-95">
                    <i data-lucide="sparkles" class="w-4 h-4 md:w-5 md:h-5 fill-current"></i> <span class="hidden md:inline">å…¨ä½“å¥–åŠ±</span>
                </button>
                <button onclick="switchView('grid')" id="btn-view-grid" class="p-2 md:px-5 md:py-2 rounded-lg font-bold transition-all flex items-center gap-2 bg-slate-700 text-white shadow-inner"><i data-lucide="layout-grid" class="w-5 h-5"></i> <span class="hidden md:inline">ç‚¹å</span></button>
                <button onclick="switchView('profile')" id="btn-view-profile" class="p-2 md:px-5 md:py-2 rounded-lg font-bold transition-all flex items-center gap-2 text-slate-400 hover:bg-slate-800"><i data-lucide="folder-open" class="w-5 h-5"></i> <span class="hidden md:inline">æ¡£æ¡ˆ</span></button>
                <button onclick="switchView('rank')" id="btn-view-rank" class="p-2 md:px-5 md:py-2 rounded-lg font-bold transition-all flex items-center gap-2 text-slate-400 hover:bg-slate-800"><i data-lucide="trophy" class="w-5 h-5"></i> <span class="hidden md:inline">æ’è¡Œ</span></button>
                <div class="w-px h-6 md:h-8 bg-slate-700 mx-1 md:mx-2 self-center"></div>
                <button onclick="switchView('manage')" id="btn-view-manage" class="p-2 text-slate-400 hover:text-white hover:bg-slate-700 rounded-lg transition-colors"><i data-lucide="settings" class="w-5 h-5 md:w-6 md:h-6"></i></button>
            </div>
            
            <div id="student-controls" class="hidden flex gap-2 items-center">
                <button onclick="handleLogout()" class="p-2 px-4 bg-slate-700 hover:bg-slate-600 text-white rounded-lg text-sm font-bold flex items-center gap-2">
                    <i data-lucide="log-out" class="w-4 h-4"></i> é€€å‡º
                </button>
            </div>
            
             <button onclick="handleLogout()" id="teacher-logout-btn" class="hidden ml-2 p-2 text-slate-500 hover:text-red-400 rounded-lg" title="é€€å‡ºç™»å½•"><i data-lucide="log-out" class="w-5 h-5"></i></button>
        </div>
    </header>

    <main id="main-container" class="flex-1 p-4 md:p-6 overflow-hidden relative hidden"></main>

    <div id="modal-overlay" class="fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm hidden animate-in fade-in p-4">
        <div id="modal-content" class="bg-slate-800 w-full max-w-2xl rounded-3xl overflow-hidden border border-slate-600 shadow-2xl relative animate-in zoom-in-95 flex flex-col max-h-[95vh] md:max-h-[90vh]"></div>
    </div>

    <div id="animation-layer" class="fixed inset-0 z-[60] flex items-center justify-center pointer-events-none hidden"></div>

    <script>
        // --- LeanCloud é…ç½® ---
        let LC_CONFIG = {
            appId: "KhWsRHjGKnK6keC0cpEAlhkX-gzGzoHsz".trim(),
            appKey: "g4CiEwnpnNOCJ14QDjrS9THm".trim(),
            serverURL: "https://khwsrhjg.lc-cn-n1-shared.com".trim()
        };

        const TEACHER_PASSWORD = "888888"; 

        // --- Configuration & Constants ---
        const AVATARS = ["ğŸ‘¦", "ğŸ‘§", "ğŸ§‘", "ğŸ‘©", "ğŸµ", "ğŸ¶", "ğŸ±", "ğŸ¦Š", "ğŸ¦", "ğŸ¯", "ğŸ¦„", "ğŸ²", "ğŸ‘½", "ğŸ¤–"];
        
        const REWARD_TYPES = [
            { id: 'answer', label: 'ç§¯æå›ç­”', coins: 2, icon: 'volume-2', color: 'bg-blue-500' },
            { id: 'help', label: 'å¸®åŠ©åŒå­¦', coins: 3, icon: 'hand-heart', color: 'bg-pink-500' },
            { id: 'creative', label: 'åˆ›æ„æƒ³æ³•', coins: 4, icon: 'lightbulb', color: 'bg-amber-500' },
            { id: 'bug', label: 'ä¿®å¤Bug', coins: 5, icon: 'code', color: 'bg-purple-500' },
            { id: 'focus', label: 'ä¸“æ³¨è®¤çœŸ', coins: 1, icon: 'zap', color: 'bg-green-500' },
        ];
        
        const DEDUCT_TYPES = [
            { id: 'disturb', label: 'æ‰°ä¹±è¯¾å ‚', coins: -2, icon: 'frown', color: 'bg-red-500' },
            { id: 'late', label: 'è¿Ÿåˆ°', coins: -1, icon: 'clock', color: 'bg-orange-500' },
            { id: 'homework', label: 'æœªäº¤ä½œä¸š', coins: -3, icon: 'file-warning', color: 'bg-rose-600' }
        ];

        const EXCHANGE_RATE = 50, SKILL_REWARD = 50, SKILL_XP = 20, ATTENDANCE_XP = 10, CLASS_REWARD_XP = 1;

        // --- Global State ---
        let state = {
            classes: [], 
            students: [],
            templates: [], 
            currentClassId: null,
            viewMode: 'grid',
            selectedStudentId: null,
            currentProfileId: null,
            profileTab: 'skills',
            isClassDropdownOpen: false,
            
            // å¼¹çª—çŠ¶æ€
            isClassRewardMode: false,
            isSkillEditorMode: false,
            isTemplateManagerMode: false, 
            isCoinEditMode: false,
            popupTab: 'reward',
            
            // ç¼–è¾‘å™¨çŠ¶æ€
            editingTemplate: null,        

            // åˆ†é…çŠ¶æ€
            isAssignModalOpen: false, 
            assignTargetStudentId: null,

            // Auth State
            userRole: null, 
            loginId: null  
        };

       // --- LeanCloud Helper (æ‰å¹³åŒ–ä¿®å¤ç‰ˆ) ---
               const DB = {
                   init: function() {
                       try {
                           if (LC_CONFIG.appId === "YOUR_APP_ID") return false;
                           AV.init(LC_CONFIG);
                           return true;
                       } catch (e) {
                           if (e.message && e.message.includes('already initialized')) return true;
                           console.error("LeanCloud Init Error:", e);
                           return false;
                       }
                   },
                   
                   fetchClasses: async function() {
                       const query = new AV.Query('ClassRoom');
                       query.ascending('createdAt');
                       try {
                           const results = await query.find();
                           return results.map(r => ({ id: r.id, ...r.attributes, lcObject: r }));
                       } catch (error) {
                           if (error.code === 101) return []; 
                           throw error; 
                       }
                   },
       
                   createClass: async function(name) {
                       const ClassRoom = AV.Object.extend('ClassRoom');
                       const room = new ClassRoom();
                       room.set('name', name);
                       const r = await room.save();
                       return { id: r.id, ...r.attributes, lcObject: r };
                   },
       
                   deleteClass: async function(lcObject) {
                       await lcObject.destroy();
                   },
       
                   fetchTemplates: async function() {
                       const query = new AV.Query('Template');
                       query.descending('updatedAt');
                       try {
                           const results = await query.find();
                           return results.map(r => ({ id: r.id, ...r.attributes, lcObject: r }));
                       } catch (error) {
                           return [];
                       }
                   },
       
                   // --- ä¿®æ”¹ï¼šç›´æ¥ä¿å­˜ skills åˆ° Templateï¼Œä¸å†ä½¿ç”¨ collections æ•°ç»„ ---
                   saveTemplate: async function(id, name, skills, bonusCoins, bonusXp) {
                       const Template = AV.Object.extend('Template');
                       let t;
                       if (id) {
                           t = AV.Object.createWithoutData('Template', id);
                       } else {
                           t = new Template();
                       }
                       t.set('name', name);
                       t.set('skills', skills); // æ‰å¹³åŒ–ï¼šç›´æ¥ä¿å­˜æŠ€èƒ½
                       t.set('bonusCoins', bonusCoins);
                       t.set('bonusXp', bonusXp);
                       
                       // æ¸…ç†æ—§ç»“æ„ï¼Œé˜²æ­¢æ··æ·†
                       t.unset('collections'); 
                       
                       const r = await t.save();
                       return { id: r.id, ...r.attributes, lcObject: r };
                   },
       
                   deleteTemplate: async function(id) {
                       const t = AV.Object.createWithoutData('Template', id);
                       await t.destroy();
                   },
       
                   fetchStudents: async function(classLcObject) {
                       const query = new AV.Query('Student');
                       query.equalTo('class', classLcObject);
                       query.limit(100); 
                       try {
                           const results = await query.find();
                           return results.map(r => {
                               const data = r.attributes;
                               if (!data.collections) data.collections = [];
                               if (!data.completedCollections) data.completedCollections = [];
                               return { id: r.id, ...data, lcObject: r };
                           });
                       } catch (error) {
                           if (error.code === 101) return []; 
                           throw error;
                       }
                   },
                   
                   findStudentByStudentId: async function(studentIdStr) {
                        const query = new AV.Query('Student');
                        query.equalTo('studentId', studentIdStr);
                        query.include('class');
                        const result = await query.first();
                        if(!result) return null;
                        const data = result.attributes;
                        if (!data.collections) data.collections = [];
                        if (!data.completedCollections) data.completedCollections = [];
                        return { id: result.id, ...data, lcObject: result, classId: result.get('class').id };
                   },
       
                   createStudent: async function(classLcObject, data) {
                       const Student = AV.Object.extend('Student');
                       const s = new Student();
                       s.set('name', data.name);
                       s.set('avatar', data.avatar);
                       s.set('studentId', data.studentId);
                       s.set('coins', data.coins);
                       s.set('xp', data.xp);
                       s.set('level', data.level);
                       s.set('unlockedSkills', []);
                       s.set('masteredSkills', []); 
                       s.set('completedCollections', []); 
                       s.set('collections', []); 
                       s.set('history', data.history);
                       s.set('lastCheckIn', ''); 
                       s.set('class', classLcObject);
                       const r = await s.save();
                       return { id: r.id, ...r.attributes, lcObject: r };
                   },
       
                   updateStudent: async function(lcObject, data) {
                       for (const key in data) {
                           lcObject.set(key, data[key]);
                       }
                       await lcObject.save(); 
                   },
       
                   deleteStudent: async function(lcObject) {
                       await lcObject.destroy();
                   },
       
                   // --- ä¿®æ”¹ï¼šåˆ†é…é€»è¾‘ï¼ˆç°åœ¨ assign çš„æ˜¯æ•´ä¸ª Template å¯¹è±¡ï¼‰ ---
                   assignTemplateToStudent: async function(studentLcObject, templateData) {
                       let current = studentLcObject.get('collections') || [];
                       
                       // æ„é€ è¦å­˜å…¥å­¦ç”Ÿæ¡£æ¡ˆçš„å›¾é‰´å¯¹è±¡
                       const newBook = {
                           id: templateData.id,  // è¿™é‡Œç»‘å®š Template IDï¼Œç”¨äºåç»­åŒæ­¥
                           name: templateData.name,
                           skills: templateData.skills,
                           bonusCoins: templateData.bonusCoins || 500,
                           bonusXp: templateData.bonusXp || 200,
                           assignedAt: new Date().toISOString()
                       };

                       // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
                       const index = current.findIndex(c => c.id === newBook.id);
                       
                       if (index !== -1) {
                           // å¦‚æœå·²å­˜åœ¨ï¼Œæ›´æ–°å†…å®¹ï¼Œä¿ç•™åˆ†é…æ—¶é—´
                           newBook.assignedAt = current[index].assignedAt;
                           current[index] = newBook;
                       } else {
                           // æ–°å¢
                           current.push(newBook);
                       }
       
                       studentLcObject.set('collections', current);
                       await studentLcObject.save();
                       return { collections: current, isUpdate: index !== -1 };
                   },
       
                   // --- ä¿®æ”¹ï¼šåŒæ­¥é€»è¾‘ï¼ˆæ‰å¹³åŒ–ï¼‰ ---
                   // å½“ä¿®æ”¹äº† Template åï¼Œæ›´æ–°æ‰€æœ‰å­¦ç”Ÿæ‰‹ä¸­æŒæœ‰è¯¥ Template ID çš„å›¾é‰´æ•°æ®
                   syncTemplateToAllStudents: async function(templateId, updatedData) {
                       const query = new AV.Query('Student');
                       query.limit(1000); 
                       const students = await query.find();
                       const updates = [];
                       let count = 0;
       
                       students.forEach(student => {
                           let userCollections = student.get('collections') || [];
                           let hasChange = false;
                           
                           // æŸ¥æ‰¾å­¦ç”Ÿæ˜¯å¦æ‹¥æœ‰è¯¥å›¾é‰´ï¼ˆé€šè¿‡ ID åŒ¹é…ï¼‰
                           const idx = userCollections.findIndex(uc => uc.id === templateId);
                           
                           if (idx !== -1) {
                               // æ‰¾åˆ°äº†ï¼Œæ›´æ–°æ•°æ®
                               const oldData = userCollections[idx];
                               
                               userCollections[idx] = {
                                   id: templateId,
                                   name: updatedData.name,
                                   skills: updatedData.skills, // åŒæ­¥æœ€æ–°çš„æŠ€èƒ½åˆ—è¡¨
                                   bonusCoins: updatedData.bonusCoins,
                                   bonusXp: updatedData.bonusXp,
                                   assignedAt: oldData.assignedAt // ä¿æŒæ—¶é—´ä¸å˜
                               };
                               
                               hasChange = true;
                           }
                           
                           if (hasChange) {
                               student.set('collections', userCollections);
                               updates.push(student);
                               count++;
                           }
                       });
       
                       if (updates.length > 0) {
                           await AV.Object.saveAll(updates);
                       }
                       return count; 
                   }
               };

        // --- Render Modal ---

        function renderModal() {
            const overlay = document.getElementById('modal-overlay');
            const content = document.getElementById('modal-content');
            overlay.classList.remove('hidden');
            
            let html = '', header = '', border = 'border-slate-600';
            
            // 1. å›¾é‰´åº“ç®¡ç†æ¨¡å¼ (Template Manager)
            if (state.isTemplateManagerMode) {
                border = 'border-indigo-500';
                header = `<div class="text-6xl mb-4 text-indigo-400 flex justify-center"><i data-lucide="library" class="w-20 h-20"></i></div><h2 class="text-3xl font-bold text-indigo-400">å›¾é‰´æ”¶é›†åº“</h2><p class="text-slate-400">åˆ›å»ºå¹¶ç®¡ç†å›¾é‰´ï¼Œç¨ååˆ†é…ç»™å­¦ç”Ÿ</p>`;
                
                const list = state.templates.map(t => `
                    <div class="bg-slate-700/50 p-4 rounded-xl border border-slate-600 mb-3 flex justify-between items-center group hover:border-indigo-500 transition-colors">
                        <div>
                            <div class="font-bold text-lg text-slate-200">${t.name}</div>
                            <div class="text-xs text-slate-500">åŒ…å« ${t.skills ? t.skills.length : 0} ä¸ªæŠ€èƒ½</div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="editTemplate('${t.id}')" class="bg-indigo-600 hover:bg-indigo-500 text-white text-xs px-3 py-2 rounded-lg font-bold flex items-center gap-1"><i data-lucide="edit" class="w-3 h-3"></i> ç¼–è¾‘</button>
                            <button onclick="deleteTemplate('${t.id}')" class="p-2 text-slate-500 hover:text-red-400 rounded-lg" title="åˆ é™¤æ¨¡æ¿"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                    </div>`).join('');

                html = `
                <div class="flex flex-col gap-4 h-full">
                    <div class="flex-1 overflow-y-auto custom-scrollbar">
                        ${list.length ? list : '<div class="text-center text-slate-500 py-10">æš‚æ— æ¨¡æ¿ï¼Œè¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ–°å»ºã€‚</div>'}
                    </div>
                    <button onclick="createNewTemplate()" class="w-full py-3 bg-indigo-600 hover:bg-indigo-500 text-white rounded-xl font-bold flex items-center justify-center gap-2">
                        <i data-lucide="plus-circle" class="w-5 h-5"></i> æ–°å»ºå›¾é‰´
                    </button>
                </div>`;
            } 
            // 2. åˆ†é…å›¾é‰´æ¨¡å¼ (Assign)
            else if (state.isAssignModalOpen) {
                const s = getStudent(state.assignTargetStudentId);
                border = 'border-green-500';
                header = `<div class="text-center mb-4"><h2 class="text-2xl font-bold text-green-400">åˆ†å‘å›¾é‰´</h2><p class="text-slate-400">ç»™ ${s.name} æ·»åŠ æ–°çš„æ”¶é›†ä»»åŠ¡</p></div>`;
                
                const list = state.templates.map(t => `
                    <button onclick="handleAssignTemplate('${t.id}')" class="w-full bg-slate-700/50 hover:bg-green-900/30 border border-slate-600 hover:border-green-500 p-4 rounded-xl mb-3 flex justify-between items-center group transition-all text-left">
                        <div>
                            <div class="font-bold text-lg text-slate-200 group-hover:text-green-300">${t.name}</div>
                            <div class="text-xs text-slate-500">åŒ…å« ${t.skills ? t.skills.length : 0} ä¸ªæŠ€èƒ½</div>
                        </div>
                        <i data-lucide="plus" class="w-5 h-5 text-slate-500 group-hover:text-green-400"></i>
                    </button>
                `).join('');
                
                html = `<div class="flex-1 overflow-y-auto custom-scrollbar p-2">${list.length ? list : '<div class="text-center text-slate-500">å›¾é‰´åº“ä¸ºç©ºï¼Œè¯·å…ˆåœ¨ç®¡ç†é¡µé¢åˆ›å»ºã€‚</div>'}</div>`;
            } 
            // 3. æŠ€èƒ½ç¼–è¾‘å™¨æ¨¡å¼ (Editor) - æ‰å¹³åŒ–æ”¹é€ ï¼šç§»é™¤å·¦ä¾§ç³»åˆ—æ 
            else if (state.isSkillEditorMode) {
                border = 'border-cyan-500';
                const t = state.editingTemplate;
                const skills = t.skills || [];
                
                header = `<div class="flex flex-col items-center gap-2 mb-2"><h2 class="text-2xl font-bold text-cyan-400">ç¼–è¾‘å›¾é‰´</h2></div>`;

                const skillsList = skills.map((s,i) => `
                    <div class="bg-slate-700/50 p-2 rounded-xl flex items-center gap-2 border border-slate-600 hover:border-slate-500 transition-colors">
                        <div class="w-6 h-6 rounded-full bg-slate-800 flex items-center justify-center text-slate-400 text-xs border border-slate-600 shrink-0">${i+1}</div>
                        <input type="text" value="${s.name}" onblur="updateSkillInEditor('${s.id}', 'name', this.value)" class="bg-transparent border-b border-transparent focus:border-cyan-500 outline-none flex-1 font-bold text-slate-200 min-w-0 text-sm">
                        <input type="number" value="${s.coins || 50}" onblur="updateSkillInEditor('${s.id}', 'coins', this.value)" class="w-12 bg-slate-800/50 border border-transparent focus:border-yellow-500 rounded px-1 py-1 text-center text-yellow-400 font-mono text-xs outline-none">
                        <input type="number" value="${s.xp || 20}" onblur="updateSkillInEditor('${s.id}', 'xp', this.value)" class="w-12 bg-slate-800/50 border border-transparent focus:border-purple-500 rounded px-1 py-1 text-center text-purple-400 font-mono text-xs outline-none">
                        <button onclick="deleteSkillFromEditor('${s.id}')" class="text-slate-500 hover:text-red-400 p-1 shrink-0"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                    </div>`).join('');

                html = `
                <div class="flex flex-col h-full overflow-hidden">
                    <div class="mb-4 bg-slate-900/50 p-3 rounded-lg border border-slate-700 flex flex-col gap-2 shrink-0">
                        <div class="flex gap-2 items-center">
                            <span class="text-xs font-bold text-slate-400 w-16">å›¾é‰´åç§°</span>
                            <input type="text" value="${t.name}" onblur="state.editingTemplate.name = this.value" class="flex-1 bg-transparent border-b border-slate-600 focus:border-cyan-500 outline-none text-cyan-300 font-bold">
                        </div>
                        <div class="flex gap-4">
                            <div class="flex gap-2 items-center flex-1">
                                <span class="text-xs font-bold text-slate-400 w-16">é›†é½é‡‘å¸</span>
                                <input type="number" value="${t.bonusCoins || 500}" onblur="state.editingTemplate.bonusCoins = parseInt(this.value)" class="flex-1 bg-slate-800 border border-slate-600 rounded px-2 py-1 text-yellow-400 font-mono text-sm focus:border-yellow-500 outline-none">
                            </div>
                            <div class="flex gap-2 items-center flex-1">
                                <span class="text-xs font-bold text-slate-400 w-16">é›†é½ XP</span>
                                <input type="number" value="${t.bonusXp || 200}" onblur="state.editingTemplate.bonusXp = parseInt(this.value)" class="flex-1 bg-slate-800 border border-slate-600 rounded px-2 py-1 text-purple-400 font-mono text-sm focus:border-purple-500 outline-none">
                            </div>
                        </div>
                    </div>

                    <div class="flex flex-wrap gap-2 mb-2 bg-slate-700/30 p-2 rounded-lg items-end shrink-0">
                        <div class="w-full sm:flex-1"><input type="text" id="new-skill-input" placeholder="è¾“å…¥æ–°æŠ€èƒ½åç§°..." class="w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-sm text-white focus:border-cyan-500"></div>
                        <div class="flex gap-2 w-full sm:w-auto">
                            <div class="flex-1 sm:w-16"><input type="number" id="new-skill-coins" value="50" placeholder="é‡‘å¸" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-2 py-2 text-white text-center focus:border-yellow-500 text-xs"></div>
                            <div class="flex-1 sm:w-16"><input type="number" id="new-skill-xp" value="20" placeholder="XP" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-2 py-2 text-white text-center focus:border-purple-500 text-xs"></div>
                            <button onclick="addSkillToEditor()" class="bg-cyan-600 hover:bg-cyan-500 text-white px-3 py-2 h-[34px] rounded-lg font-bold flex items-center justify-center shrink-0"><i data-lucide="plus" class="w-4 h-4"></i></button>
                        </div>
                    </div>

                    <div class="flex-1 overflow-y-auto custom-scrollbar pr-1 space-y-1">
                        ${skillsList.length ? skillsList : '<div class="text-center text-slate-500 py-4">æš‚æ— æŠ€èƒ½ï¼Œè¯·æ·»åŠ </div>'}
                    </div>

                    <div class="mt-4 pt-4 border-t border-slate-700 flex gap-4 shrink-0">
                        <button onclick="openTemplateLibrary()" class="flex-1 py-3 bg-slate-700 hover:bg-slate-600 text-slate-300 rounded-xl font-bold">æ”¾å¼ƒ</button>
                        <button onclick="saveCurrentTemplate()" class="flex-[2] py-3 bg-green-600 hover:bg-green-500 text-white rounded-xl font-bold flex items-center justify-center gap-2"><i data-lucide="save" class="w-5 h-5"></i> ä¿å­˜å›¾é‰´</button>
                    </div>
                </div>`;
            } 
            // 4. é‡‘å¸ç¼–è¾‘æ¨¡å¼
            else if (state.isCoinEditMode) {
                const s = getStudent(state.selectedStudentId);
                border = 'border-amber-500';
                header = `<div class="text-6xl mb-4 text-amber-400 flex justify-center"><i data-lucide="coins" class="w-20 h-20"></i></div><h2 class="text-3xl font-bold text-amber-400">ä¿®æ”¹é‡‘å¸</h2><p class="text-slate-400 mt-2">å½“å‰: ${s.coins}</p>`;
                html = `<div class="flex flex-col gap-4"><div><label class="block text-sm text-slate-400 mb-1">å˜åŠ¨æ•°é‡</label><input type="number" id="edit-coin-amount" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-3 text-white text-xl font-bold focus:border-amber-500" placeholder="100 æˆ– -50"></div><div><label class="block text-sm text-slate-400 mb-1">åŸå› </label><input type="text" id="edit-coin-reason" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-3 text-white focus:border-amber-500" placeholder="è€å¸ˆè°ƒæ•´"></div><button onclick="handleCoinEdit()" class="w-full bg-amber-500 text-slate-900 font-bold py-3 rounded-lg hover:bg-amber-400 mt-2">ç¡®è®¤</button></div>`;
            } 
            // 5. å…¨ç­å¥–åŠ±æ¨¡å¼
            else if (state.isClassRewardMode) {
                border = 'border-pink-500';
                header = `<div class="text-6xl mb-4 flex justify-center gap-2 animate-bounce"><span>ğŸš€</span></div><h2 class="text-3xl font-bold text-pink-400">å…¨ç­å¥–åŠ±</h2>`;
                html = `<div class="grid grid-cols-3 gap-4">${REWARD_TYPES.map(r => `<button onclick="handleReward('${r.id}')" class="${r.color} h-32 rounded-2xl flex flex-col items-center justify-center gap-2 text-white hover:scale-105 active:scale-95 transition-transform shadow-lg"><div class="p-2 bg-white/20 rounded-full"><i data-lucide="${r.icon}" class="w-6 h-6"></i></div><div class="font-bold text-lg">${r.label}</div><div class="font-black text-2xl opacity-80">+${r.coins}</div></button>`).join('')}</div>`;
            } 
            // 6. å­¦ç”Ÿä¸ªäººæ“ä½œ (é»˜è®¤)
            else {
                const s = getStudent(state.selectedStudentId);
                header = `<div class="flex flex-col items-center"><div class="text-6xl mb-2">${s.avatar}</div><h2 class="text-3xl font-bold flex items-center gap-2">${s.name}<div class="text-lg bg-yellow-500/20 text-yellow-300 px-3 py-1 rounded-full font-mono transition-all duration-300" id="modal-coin-display">$${s.coins}</div></h2></div>`;
                
                const tabs = `<div class="flex border-b border-slate-700 mx-8 mb-6"><button onclick="state.popupTab='reward';renderModal()" class="flex-1 pb-3 text-lg font-bold transition-colors border-b-2 ${state.popupTab==='reward'?'text-indigo-400 border-indigo-500':'text-slate-500 border-transparent'}">å¥–åŠ±ä¸æƒ©ç½š</button><button onclick="state.popupTab='exchange';renderModal()" class="flex-1 pb-3 text-lg font-bold transition-colors border-b-2 ${state.popupTab==='exchange'?'text-amber-400 border-amber-500':'text-slate-500 border-transparent'}">å…‘æ¢</button></div>`;
                
                if(state.popupTab === 'reward') {
                    const rewardBtns = REWARD_TYPES.map(r => `<button onclick="handleReward('${r.id}')" class="${r.color} h-32 rounded-2xl flex flex-col items-center justify-center gap-2 text-white hover:scale-105 active:scale-95 transition-transform shadow-lg"><div class="p-2 bg-white/20 rounded-full"><i data-lucide="${r.icon}" class="w-6 h-6"></i></div><div class="font-bold text-lg">${r.label}</div><div class="font-black text-2xl opacity-80">+${r.coins}</div></button>`).join('');
                    const deductBtns = DEDUCT_TYPES.map(r => `<button onclick="handleReward('${r.id}')" class="${r.color} h-24 rounded-xl flex flex-col items-center justify-center gap-1 text-white hover:scale-105 active:scale-95 transition-transform shadow-lg opacity-90 hover:opacity-100"><div class="flex items-center gap-2"><i data-lucide="${r.icon}" class="w-4 h-4"></i><span class="font-bold text-sm">${r.label}</span></div><div class="font-mono font-bold">${r.coins} (XP-1)</div></button>`).join('');
                    html = `${tabs}<div class="space-y-6"><div><h3 class="text-slate-400 text-xs font-bold uppercase tracking-wider mb-3">å¥–åŠ±é¡¹ç›®</h3><div class="grid grid-cols-3 gap-4">${rewardBtns}</div></div><div class="pt-4 border-t border-slate-700/50"><h3 class="text-slate-400 text-xs font-bold uppercase tracking-wider mb-3">æ‰£é™¤é¡¹ç›®</h3><div class="grid grid-cols-3 gap-4">${deductBtns}</div></div></div>`;
                } else {
                    const canAfford = s.coins >= EXCHANGE_RATE;
                    html = `${tabs}<div class="bg-slate-700/50 rounded-2xl p-6 flex flex-col items-center gap-6 border border-slate-600"><div class="flex items-center gap-8 text-slate-300"><div class="text-center"><div class="text-sm uppercase opacity-70">æ±‡ç‡</div><div class="text-xl font-bold flex items-center gap-2"><i data-lucide="coins" class="text-yellow-500"></i> ${EXCHANGE_RATE} = <i data-lucide="stamp" class="text-red-400"></i> 1</div></div><div class="w-px h-10 bg-slate-600"></div><div class="text-center"><div class="text-sm uppercase opacity-70">æŒæœ‰</div><div class="text-xl font-bold ${canAfford?'text-green-400':'text-red-400'}">${s.coins}</div></div></div><button onclick="handleExchange()" ${!canAfford?'disabled':''} class="w-full py-4 rounded-xl font-black text-xl flex items-center justify-center gap-3 transition-all shadow-lg ${canAfford?'bg-amber-500 hover:bg-amber-400 text-slate-900 active:scale-95':'bg-slate-600 text-slate-400 cursor-not-allowed'}">${canAfford?'<i data-lucide="shopping-bag" class="w-6 h-6"></i> å…‘æ¢å°ç« ':'ä½™é¢ä¸è¶³'}</button></div>`;
                }
            }

            content.className = `bg-slate-800 w-full max-w-5xl rounded-3xl overflow-hidden border border-slate-600 shadow-2xl relative animate-in zoom-in-95 flex flex-col ${border} h-[90vh] md:h-[80vh]`;
            content.innerHTML = `<div class="relative p-4 md:p-8 pb-2 md:pb-4 text-center shrink-0"><button onclick="closeModal()" class="absolute top-3 right-3 md:top-4 md:right-4 p-2 bg-slate-700 rounded-full text-slate-300 hover:text-white z-10"><i data-lucide="x" class="w-5 h-5 md:w-6 md:h-6"></i></button>${header}</div><div class="p-4 md:p-8 pt-0 flex-1 overflow-y-auto custom-scrollbar flex flex-col">${html}</div>`;
            lucide.createIcons();
        }

        // --- App Logic ---

        async function bootstrap() {
            if (typeof AV === 'undefined') {
                showError("LeanCloud SDK åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œã€‚");
                return;
            }

            if (!DB.init()) {
                document.getElementById('login-layer').classList.add('hidden');
                openSetupModal(); 
                return;
            }
            lucide.createIcons();
        }

        // --- Auth Functions ---
        
        function switchLoginTab(type) {
            const btnT = document.getElementById('tab-teacher');
            const btnS = document.getElementById('tab-student');
            const formT = document.getElementById('form-teacher');
            const formS = document.getElementById('form-student');

            if (type === 'teacher') {
                btnT.classList.replace('text-slate-400', 'text-white');
                btnT.classList.replace('hover:text-slate-200', 'bg-slate-700');
                btnS.classList.replace('text-white', 'text-slate-400');
                btnS.classList.replace('bg-slate-700', 'hover:text-slate-200');
                formT.classList.remove('hidden');
                formS.classList.add('hidden');
            } else {
                btnS.classList.replace('text-slate-400', 'text-white');
                btnS.classList.replace('hover:text-slate-200', 'bg-slate-700');
                btnT.classList.replace('text-white', 'text-slate-400');
                btnT.classList.replace('bg-slate-700', 'hover:text-slate-200');
                formS.classList.remove('hidden');
                formT.classList.add('hidden');
            }
        }

        async function handleTeacherLogin() {
            const pwd = document.getElementById('teacher-pwd').value;
            if (pwd !== TEACHER_PASSWORD) {
                alert("å¯†ç é”™è¯¯");
                return;
            }
            
            toggleLoading(true, "æ­£åœ¨è¿æ¥äº‘ç«¯...");
            state.userRole = 'teacher';
            
            const success = await initData();
            
            if (success) {
                document.getElementById('login-layer').classList.add('hidden');
                document.getElementById('app-header').classList.remove('hidden');
                document.getElementById('main-container').classList.remove('hidden');
                toggleLoading(false);
                renderAll();
            } else {
                const setupModal = document.getElementById('setup-modal');
                if (!setupModal.classList.contains('hidden')) {
                    toggleLoading(false);
                }
            }
        }

        async function handleStudentLogin() {
            const sid = document.getElementById('student-id-input').value.trim();
            if (!sid || sid.length < 4) {
                alert("è¯·è¾“å…¥æ­£ç¡®çš„å­¦å·");
                return;
            }

            toggleLoading(true, "æŸ¥æ‰¾å­¦ç”Ÿæ¡£æ¡ˆ...");
            try {
                const student = await DB.findStudentByStudentId(sid);
                if (!student) {
                    toggleLoading(false);
                    alert("æœªæ‰¾åˆ°è¯¥å­¦å·ï¼Œè¯·è”ç³»è€å¸ˆæ ¸å¯¹ã€‚");
                    return;
                }

                state.userRole = 'student';
                state.loginId = student.id;
                
                state.classes = await DB.fetchClasses();
                state.currentClassId = student.classId;
                state.students = [student]; 
                state.currentProfileId = student.id;
                state.viewMode = 'profile';

                document.getElementById('login-layer').classList.add('hidden');
                document.getElementById('app-header').classList.remove('hidden');
                document.getElementById('main-container').classList.remove('hidden');
                
                toggleLoading(false);
                renderAll();

            } catch(e) {
                toggleLoading(false);
                alert("ç™»å½•å¤±è´¥: " + e.message);
            }
        }

        function handleLogout() {
            location.reload();
        }

        // --- Init Data ---

        async function initData() {
            try {
                state.classes = await DB.fetchClasses();
                state.templates = await DB.fetchTemplates();

                if (state.classes.length === 0) {
                    try {
                        const newClass = await DB.createClass('ç¤ºä¾‹ç­çº§');
                        state.classes.push(newClass);
                    } catch(e) {
                         console.warn("Auto create class failed:", e);
                    }
                }

                if (state.classes.length > 0) {
                    state.currentClassId = state.classes[0].id;
                    await loadCurrentClassStudents();
                } else {
                    state.currentClassId = null;
                    state.students = [];
                }
                return true; 
            } catch (error) {
                console.error("Init Error:", error);
                if(error.message && (error.message.includes('401') || error.message.includes('Unauthorized'))) {
                    openSetupModal(true); 
                } else {
                    showError("åˆå§‹åŒ–å¤±è´¥: " + error.message);
                }
                return false;
            }
        }

        function openSetupModal(isError = false) {
            const modal = document.getElementById('setup-modal');
            const msg = document.getElementById('setup-msg');
            modal.classList.remove('hidden');
            
            if (isError) {
                msg.innerHTML = '<span class="text-red-400">è®¤è¯å¤±è´¥ (401)</span><br>è¯·æ£€æŸ¥ AppID å’Œ Key æ˜¯å¦æ­£ç¡®ã€‚';
            } else {
                msg.innerHTML = 'è¯·è¾“å…¥æ‚¨çš„ LeanCloud åº”ç”¨å‡­è¯ã€‚';
            }
            
            if (LC_CONFIG.appId !== "YOUR_APP_ID") {
                document.getElementById('setup-app-id').value = LC_CONFIG.appId;
                document.getElementById('setup-app-key').value = LC_CONFIG.appKey;
                document.getElementById('setup-server-url').value = LC_CONFIG.serverURL;
            }
        }

        function saveConfigAndRetry() {
            const appId = document.getElementById('setup-app-id').value.trim();
            const appKey = document.getElementById('setup-app-key').value.trim();
            const serverURL = document.getElementById('setup-server-url').value.trim();
            
            if(!appId || !appKey || !serverURL) return alert("è¯·å¡«å†™æ‰€æœ‰å­—æ®µ");
            
            LC_CONFIG = { appId, appKey, serverURL };
            document.getElementById('setup-modal').classList.add('hidden');
            
            try {
                bootstrap();
            } catch(e) {
                location.reload(); 
            }
        }

        async function loadCurrentClassStudents() {
            if(state.userRole === 'student') return; 
            toggleLoading(true, "åŠ è½½å­¦ç”Ÿæ•°æ®...");
            const currentClass = state.classes.find(c => c.id === state.currentClassId);
            if (currentClass) {
                state.students = await DB.fetchStudents(currentClass.lcObject);
                if (state.students.length > 0) state.currentProfileId = state.students[0].id;
                else state.currentProfileId = null;
            }
            toggleLoading(false);
        }

        function toggleLoading(show, text) {
            const el = document.getElementById('loading-layer');
            const msg = document.getElementById('loading-text');
            const err = document.getElementById('error-message');
            const btn = document.getElementById('retry-btn');
            
            if (show) {
                el.classList.remove('hidden');
                err.classList.add('hidden');
                btn.classList.add('hidden');
                if(text) msg.innerText = text;
            } else {
                el.classList.add('hidden');
            }
        }

        function showError(msg) {
            const el = document.getElementById('loading-layer');
            el.classList.remove('hidden');
            document.getElementById('loading-text').innerText = "å‘ç”Ÿé”™è¯¯";
            document.querySelector('.spinner').classList.add('hidden');
            
            const errEl = document.getElementById('error-message');
            errEl.innerText = msg;
            errEl.classList.remove('hidden');
            
            document.getElementById('retry-btn').classList.remove('hidden');
        }

        // --- Data Helpers ---
        const getCurrentClass = () => state.classes.find(c => c.id === state.currentClassId);
        const getStudent = (id) => state.students.find(s => s.id === id);
        const getRequiredXp = (level) => level * 30;
        const generateStudentId = () => Math.floor(100000 + Math.random() * 900000).toString();

        // --- Logic: Template Manager & Assignment ---

        async function openTemplateLibrary() {
            resetModalState();
            toggleLoading(true, "åŠ è½½å›¾é‰´åº“...");
            state.templates = await DB.fetchTemplates();
            toggleLoading(false);
            state.isTemplateManagerMode = true;
            renderModal();
        }

        function createNewTemplate() {
            const name = prompt("è¯·è¾“å…¥æ–°å›¾é‰´åç§° (å¦‚: Pythonå…¥é—¨):");
            if (!name) return;
            state.editingTemplate = {
                id: null,
                name: name,
                skills: [], // æ‰å¹³åŒ–ï¼šç›´æ¥åˆå§‹åŒ– skills
                bonusCoins: 500,
                bonusXp: 200
            };
            state.isTemplateManagerMode = false;
            state.isSkillEditorMode = true;
            renderModal();
        }

        function editTemplate(tId) {
            const t = state.templates.find(x => x.id === tId);
            if (!t) return;
            state.editingTemplate = JSON.parse(JSON.stringify(t));
            state.editingTemplate.lcObject = t.lcObject;
            
            // å…¼å®¹æ—§æ•°æ®ï¼šå¦‚æœæ—§æ•°æ®æœ‰ collectionsï¼ŒæŠŠç¬¬ä¸€ä¸ª collection çš„æŠ€èƒ½æå‡ºæ¥
            if (state.editingTemplate.collections && state.editingTemplate.collections.length > 0) {
                 const firstCol = state.editingTemplate.collections[0];
                 state.editingTemplate.skills = firstCol.skills || [];
                 state.editingTemplate.bonusCoins = firstCol.bonusCoins || 500;
                 state.editingTemplate.bonusXp = firstCol.bonusXp || 200;
            }
            if (!state.editingTemplate.skills) state.editingTemplate.skills = [];

            state.isTemplateManagerMode = false;
            state.isSkillEditorMode = true;
            renderModal();
        }

		async function saveCurrentTemplate() {
		            if (!state.editingTemplate) return;
		            if (!state.editingTemplate.name) return alert("è¯·è¾“å…¥å›¾é‰´åç§°");
		
		            toggleLoading(true, "ä¿å­˜å›¾é‰´...");
		            try {
		                // 1. ä¿å­˜æ¨¡æ¿æœ¬èº«åˆ°äº‘ç«¯ (ä¿å­˜ skills, bonusCoins, bonusXp)
		                const saved = await DB.saveTemplate(
		                    state.editingTemplate.id, 
		                    state.editingTemplate.name, 
		                    state.editingTemplate.skills,
                            state.editingTemplate.bonusCoins,
                            state.editingTemplate.bonusXp
		                );
		                
		                // æ›´æ–°æœ¬åœ°çŠ¶æ€ä¸­çš„åˆ—è¡¨
		                const idx = state.templates.findIndex(t => t.id === saved.id);
		                if (idx >= 0) state.templates[idx] = saved;
		                else state.templates.unshift(saved);
		
		                toggleLoading(false); 
		                
		                // 2. [æ ¸å¿ƒé€»è¾‘] è‡ªåŠ¨åŒæ­¥
		                if (state.editingTemplate.id) {
                            toggleLoading(true, "æ­£åœ¨æ™ºèƒ½åŒæ­¥ç»™æ‰€æœ‰å­¦ç”Ÿ...");
                            // åŒæ­¥æ—¶ä¼ é€’å¯¹è±¡ç»“æ„
                            const count = await DB.syncTemplateToAllStudents(saved.id, {
                                name: saved.name,
                                skills: saved.skills,
                                bonusCoins: saved.bonusCoins,
                                bonusXp: saved.bonusXp
                            });
                            toggleLoading(false);
                            if(count > 0) alert(`ä¿å­˜æˆåŠŸï¼\nå·²è‡ªåŠ¨æ›´æ–°äº† ${count} ä½å­¦ç”Ÿçš„å›¾é‰´è¿›åº¦ã€‚`);
                            else alert("ä¿å­˜æˆåŠŸï¼");
		                } else {
		                    alert("âœ… æ–°å»ºå›¾é‰´ä¿å­˜æˆåŠŸï¼");
		                }
		
		                // è¿”å›åˆ—è¡¨é¡µ
		                openTemplateLibrary();
		            } catch (e) {
		                toggleLoading(false);
		                console.error(e);
		                alert("ä¿å­˜å¤±è´¥: " + e.message);
		            }
		        }

        async function deleteTemplate(tId) {
            if(!confirm("ç¡®å®šåˆ é™¤æ­¤å›¾é‰´å—ï¼Ÿå·²åˆ†é…ç»™å­¦ç”Ÿçš„å›¾é‰´ä¸ä¼šå—å½±å“ã€‚")) return;
            await DB.deleteTemplate(tId);
            state.templates = state.templates.filter(t => t.id !== tId);
            renderModal();
        }

        async function openAssignModal(studentId) {
            resetModalState();
            state.assignTargetStudentId = studentId;
            if (state.templates.length === 0) {
                toggleLoading(true, "åŠ è½½å›¾é‰´åº“...");
                try {
                    state.templates = await DB.fetchTemplates();
                } catch(e) {
                    console.error("åŠ è½½å›¾é‰´å¤±è´¥", e);
                }
                toggleLoading(false);
            }
            state.isAssignModalOpen = true;
            renderModal();
        }
        
        async function moveCollection(studentId, index, direction) {
            const student = getStudent(studentId);
            if (!student || !student.collections) return;
            const newIndex = index + direction;
            if (newIndex < 0 || newIndex >= student.collections.length) return;
            const temp = student.collections[index];
            student.collections[index] = student.collections[newIndex];
            student.collections[newIndex] = temp;
            renderAll();
            try {
                student.lcObject.set('collections', student.collections);
                await student.lcObject.save();
            } catch (e) { console.error("æ’åºä¿å­˜å¤±è´¥", e); }
        }

       async function handleAssignTemplate(templateId) {
                  const template = state.templates.find(t => t.id === templateId);
                  if (!template) return alert("æœªæ‰¾åˆ°é€‰æ‹©çš„å›¾é‰´");
                  
                  const student = getStudent(state.assignTargetStudentId);
                  if (!student) return alert("æœªæ‰¾åˆ°ç›®æ ‡å­¦ç”Ÿ");
       
                  if(!confirm(`ç¡®å®šè¦å°†ã€${template.name}ã€‘æ·»åŠ åˆ°ã€${student.name}ã€‘çš„ä»»åŠ¡åˆ—è¡¨ä¸­å—ï¼Ÿ`)) return;
       
                  closeModal(); 
                  toggleLoading(true, "æ­£åœ¨åˆ†å‘å›¾é‰´...");
                  try {
                      // ä¼ é€’æ•´ä¸ª template å¯¹è±¡è¿›è¡Œåˆ†é…
                      const result = await DB.assignTemplateToStudent(student.lcObject, template);
                      student.collections = result.collections;
                      
                      toggleLoading(false);
                      
                      if (result.isUpdate) {
                          alert(`âœ… ${student.name} çš„å›¾é‰´å·²æ›´æ–°è‡³æœ€æ–°ç‰ˆæœ¬ï¼`);
                      } else {
                          // æ’­æ”¾è·å¾—æ–°å›¾é‰´çš„åŠ¨ç”»
                          playAnimation({ type: 'new_collection', studentId: student.id, label: template.name });
                      }
                      
                      if (state.viewMode === 'profile' && state.currentProfileId === student.id) {
                          renderAll();
                      }
                  } catch (e) {
                      toggleLoading(false);
                      alert("åˆ†é…å¤±è´¥: " + e.message);
                  }
              }
       
       async function removeCollectionFromStudent(sid, cid) {
            if(!confirm("ç¡®å®šè¦ä»è¯¥å­¦ç”Ÿæ¡£æ¡ˆä¸­ç§»é™¤æ­¤å›¾é‰´å—ï¼Ÿ\nå·²è·å¾—çš„æŠ€èƒ½å’Œé‡‘å¸ä¸ä¼šè¢«æ”¶å›ã€‚")) return;
            
            toggleLoading(true, "æ­£åœ¨ç§»é™¤...");
            try {
                const s = getStudent(sid);
                s.collections = s.collections.filter(c => c.id !== cid);
                s.lcObject.set('collections', s.collections);
                await s.lcObject.save();
                toggleLoading(false);
                renderAll(); 
            } catch(e) {
                toggleLoading(false);
                alert("ç§»é™¤å¤±è´¥: " + e.message);
            }
        }

        // --- Logic: Editor Inner Functions ---

        function addSkillToEditor() {
            const name = document.getElementById('new-skill-input').value.trim();
            const coins = parseInt(document.getElementById('new-skill-coins').value) || 50;
            const xp = parseInt(document.getElementById('new-skill-xp').value) || 20;
            if(!name) return;
            
            // ç›´æ¥æ·»åŠ åˆ° template.skills
            state.editingTemplate.skills.push({ id: `s${Date.now()}`, name: name, coins: coins, xp: xp });
            renderModal(); 
        }

        function updateSkillInEditor(id, field, value) {
            const skill = state.editingTemplate.skills.find(s => s.id === id);
            if (skill) {
                if(field === 'coins' || field === 'xp') skill[field] = parseInt(value) || 0;
                else skill[field] = value;
            }
        }

        function deleteSkillFromEditor(id) {
            state.editingTemplate.skills = state.editingTemplate.skills.filter(s => s.id !== id);
            renderModal();
        }

        // --- Main Actions ---

        async function handleSwitchClass(classId) {
            if(state.userRole === 'student') return;
            state.currentClassId = classId;
            state.isClassDropdownOpen = false;
            state.viewMode = 'grid'; 
            await loadCurrentClassStudents();
            renderAll();
        }

        async function handleAddClass() {
            const input = document.getElementById('new-class-input');
            const name = input.value.trim();
            if (!name) return;
            toggleLoading(true, "åˆ›å»ºç­çº§ä¸­...");
            const newClass = await DB.createClass(name);
            state.classes.push(newClass);
            state.currentClassId = newClass.id;
            input.value = '';
            await loadCurrentClassStudents(); 
            toggleLoading(false);
            renderAll();
        }

        async function handleDeleteClass(e, classId) {
            e.stopPropagation();
            if(!confirm("å±é™©æ“ä½œï¼šåˆ é™¤ç­çº§å°†æ°¸ä¹…åˆ é™¤è¯¥ç­çº§ä¸‹æ‰€æœ‰å­¦ç”Ÿæ•°æ®ï¼ç¡®è®¤å—ï¼Ÿ")) return;
            toggleLoading(true, "åˆ é™¤ä¸­...");
            const cls = state.classes.find(c => c.id === classId);
            if (cls) {
                await DB.deleteClass(cls.lcObject);
                state.classes = state.classes.filter(c => c.id !== classId);
                if (state.currentClassId === classId && state.classes.length > 0) {
                    state.currentClassId = state.classes[0].id;
                    await loadCurrentClassStudents();
                } else if (state.classes.length === 0) {
                     state.students = [];
                }
            }
            toggleLoading(false);
            renderAll();
        }

        async function handleAddStudent() {
            const cls = getCurrentClass();
            if (!cls) return;
            toggleLoading(true, "æ­£åœ¨åˆ›å»ºæ¡£æ¡ˆ..."); 
            try {
                const newStudentData = {
                    name: "æ–°åŒå­¦",
                    avatar: AVATARS[Math.floor(Math.random() * AVATARS.length)],
                    studentId: generateStudentId(),
                    coins: 0, level: 1, xp: 0, 
                    history: []
                };
                const newStudent = await DB.createStudent(cls.lcObject, newStudentData);
                state.students.push(newStudent);
                toggleLoading(false);
                renderManageView(document.getElementById('main-container')); 
            } catch (error) {
                toggleLoading(false);
                alert("æ·»åŠ å¤±è´¥: " + error.message);
            }
        }

        async function handleUpdateStudent(id, field, value) {
            const s = getStudent(id);
            if (s) {
                s[field] = value;
                DB.updateStudent(s.lcObject, { [field]: value });
            }
        }
        
        async function handleDeleteStudent(e, id) {
            e.stopPropagation();
            if(!confirm("ç¡®å®šåˆ é™¤è¯¥å­¦ç”Ÿå—ï¼Ÿ")) return;
            toggleLoading(true, "æ­£åœ¨åˆ é™¤...");
            try {
                const s = getStudent(id);
                if (s) {
                    await DB.deleteStudent(s.lcObject);
                    state.students = state.students.filter(st => st.id !== id);
                }
                toggleLoading(false);
                renderManageView(document.getElementById('main-container'));
            } catch (error) {
                toggleLoading(false);
                alert("åˆ é™¤å¤±è´¥: " + error.message);
            }
        }

        async function modifyStudent(student, amount, reason, xpAmount = 0) {
            student.coins += amount;
            if (reason) {
                student.history.unshift({
                    date: new Date().toLocaleString(),
                    amount: amount,
                    reason: reason,
                    balance: student.coins
                });
                if (student.history.length > 50) student.history.pop();
            }
            
            let leveledUp = false;
            if (xpAmount > 0) {
                student.xp += xpAmount;
                let required = getRequiredXp(student.level);
                while (student.xp >= required && student.level < 100) {
                    student.xp -= required;
                    student.level++;
                    required = getRequiredXp(student.level);
                    leveledUp = true;
                }
            } else if (xpAmount < 0) {
                student.xp += xpAmount;
                if(student.xp < 0) student.xp = 0;
            }

            renderAll();

            DB.updateStudent(student.lcObject, {
                coins: student.coins,
                history: student.history,
                xp: student.xp,
                level: student.level
            }).catch(err => console.error("Cloud save failed:", err));

            return leveledUp;
        }

        async function checkIn(event, studentId) {
            event.stopPropagation();
            if(state.userRole === 'student') return; 
            
            const student = getStudent(studentId);
            if (!student) return;
            
            const today = new Date().toDateString();
            if (student.lastCheckIn === today) return;

            const attendanceCoins = 10 + student.level;
            student.lastCheckIn = today;
            
            DB.updateStudent(student.lcObject, { lastCheckIn: today });
            const leveledUp = await modifyStudent(student, attendanceCoins, "æ¯æ—¥ç­¾åˆ°", ATTENDANCE_XP);

            if (leveledUp) {
                setTimeout(() => playAnimation({ type: 'level_up', studentId: student.id, level: student.level }), 500);
            } else {
                playAnimation({ type: 'check_in', studentId: student.id, amount: attendanceCoins });
            }
        }

        async function handleReward(typeId) {
            if(state.userRole === 'student') return; 
            const reward = REWARD_TYPES.find(r => r.id === typeId);
            const deduct = DEDUCT_TYPES.find(r => r.id === typeId);
            const item = reward || deduct;
            if (!item) return;

            const xpChange = reward ? CLASS_REWARD_XP : -1;
            const logPrefix = reward ? "å¥–åŠ±" : "æ‰£é™¤";
            let animationData = {};
            
            if (state.isClassRewardMode) {
                const updates = state.students.map(s => {
                    s.coins += item.coins;
                    if(xpChange > 0) {
                        s.xp += xpChange;
                        let req = getRequiredXp(s.level);
                        if (s.xp >= req) { s.xp -= req; s.level++; }
                    } else {
                        s.xp += xpChange;
                        if (s.xp < 0) s.xp = 0;
                    }
                    s.history.unshift({date: new Date().toLocaleString(), amount: item.coins, reason: `å…¨ç­: ${item.label}`, balance: s.coins});
                    if (s.history.length > 50) s.history.pop();
                    s.lcObject.set('coins', s.coins);
                    s.lcObject.set('xp', s.xp);
                    s.lcObject.set('level', s.level);
                    s.lcObject.set('history', s.history);
                    return s.lcObject;
                });
                renderAll(); 
                await AV.Object.saveAll(updates);
                animationData = { type: 'class_reward', amount: item.coins, label: item.label };
            } else {
                const student = getStudent(state.selectedStudentId);
                if (student) {
                    const leveledUp = await modifyStudent(student, item.coins, `${logPrefix}: ${item.label}`, xpChange);
                    renderModal(); 
                    if (leveledUp) {
                         setTimeout(() => playAnimation({ type: 'level_up', studentId: student.id, level: student.level }), 500);
                    } else {
                         playAnimation({ type: 'single_reward', studentId: student.id, amount: item.coins, label: item.label });
                    }
                }
            }
            if(animationData.type) playAnimation(animationData);
        }

        async function handleExchange() {
            const student = getStudent(state.selectedStudentId);
            if (!student) return;
            if(state.userRole === 'student') return alert("è¯·è”ç³»è€å¸ˆè¿›è¡Œå…‘æ¢");
            if (student.coins < EXCHANGE_RATE) return alert("é‡‘å¸ä¸è¶³ï¼Œæ— æ³•å…‘æ¢");
            if (!confirm(`ç¡®è®¤æ¶ˆè€— ${EXCHANGE_RATE} é‡‘å¸å…‘æ¢ä¸€æšå°ç« å—ï¼Ÿ`)) return;

            closeModal();
            await modifyStudent(student, -EXCHANGE_RATE, "å…‘æ¢å°ç« ");
            playAnimation({ type: 'exchange', amount: EXCHANGE_RATE });
        }
        
        async function unlockSkill(studentId, skillId, collectionId) {
                    if(state.userRole === 'student') return; 
        
                    const student = getStudent(studentId);
                    // æ‰å¹³åŒ–æŸ¥æ‰¾
                    const collection = student.collections ? student.collections.find(c => c.id === collectionId) : null;
                    if (!collection) return;
                    
                    const skill = collection.skills.find(s => s.id === skillId);
                    if (!student || !skill) return;
        
                    if (!student.unlockedSkills) student.unlockedSkills = [];
                    if (!student.masteredSkills) student.masteredSkills = [];
                    if (!student.completedCollections) student.completedCollections = [];
                    
                    const isUnlocked = student.unlockedSkills.includes(skillId);
                    const isMastered = student.masteredSkills.includes(skillId);
                    const rewardCoins = skill.coins !== undefined ? parseInt(skill.coins) : SKILL_REWARD;
                    const rewardXp = skill.xp !== undefined ? parseInt(skill.xp) : SKILL_XP;
        
                    if (isMastered) return; 
        
                    if (isUnlocked) {
                        if (confirm(`ã€å¤ä¹ éªŒè¯ã€‘\nå­¦ç”Ÿæ˜¯å¦è¿˜è®°å¾—ã€${skill.name}ã€‘ï¼Ÿ\n\nç‚¹å‡»[ç¡®å®š]ï¼šéªŒè¯æˆåŠŸï¼Œæ°¸ä¹…ç‚¹äº®ã€‚\nç‚¹å‡»[å–æ¶ˆ]ï¼šéªŒè¯å¤±è´¥ï¼Œå°†é—å¿˜æ­¤æŠ€èƒ½ã€‚`)) {
                            
                            student.masteredSkills.push(skillId);
                            await DB.updateStudent(student.lcObject, { masteredSkills: student.masteredSkills });
                            await modifyStudent(student, rewardCoins, `å¤ä¹ : ${skill.name}`, rewardXp);
        
                            // é›†é½æ£€æŸ¥
                            const allMastered = collection.skills.every(s => student.masteredSkills.includes(s.id));
                            const isAlreadyCompleted = student.completedCollections.includes(collection.id);
        
                            if (allMastered && !isAlreadyCompleted) {
                                student.completedCollections.push(collection.id);
                                await DB.updateStudent(student.lcObject, { completedCollections: student.completedCollections });
                                setTimeout(async () => {
                                    const bonusCoins = collection.bonusCoins || 500;
                                    const bonusXp = collection.bonusXp || 200;
                                    await modifyStudent(student, bonusCoins, `é›†é½å›¾é‰´: ${collection.name}`, bonusXp);
                                    playAnimation({
                                        type: 'collection_complete',
                                        studentId: student.id,
                                        amount: bonusCoins,
                                        label: collection.name
                                    });
                                }, 800);
                            } else {
                                setTimeout(() => playAnimation({ 
                                    type: 'skill_unlock', 
                                    studentId: student.id, 
                                    amount: rewardCoins, 
                                    xp: rewardXp, 
                                    label: skill.name + " (ç²¾é€š)", 
                                    title: 'æŠ€èƒ½ç²¾é€š', 
                                    theme: 'cyan' 
                                }), 100);
                            }
        
                        } else {
                            student.unlockedSkills = student.unlockedSkills.filter(id => id !== skillId);
                            await DB.updateStudent(student.lcObject, { unlockedSkills: student.unlockedSkills });
                            await modifyStudent(student, -rewardCoins, `é—å¿˜: ${skill.name}`, -rewardXp);
                        }
                    } else {
                        if (!confirm(`ç¡®è®¤åˆæ¬¡å­¦ä¹ ã€${skill.name}ã€‘å—ï¼Ÿ`)) return;
                        student.unlockedSkills.push(skillId);
                        await DB.updateStudent(student.lcObject, { unlockedSkills: student.unlockedSkills });
                        const leveledUp = await modifyStudent(student, rewardCoins, `å­¦ä¹ : ${skill.name}`, rewardXp);
                        
                        if (leveledUp) {
                            setTimeout(() => playAnimation({ type: 'level_up', studentId: student.id, level: student.level }), 500);
                        } else {
                            setTimeout(() => playAnimation({ 
                                type: 'skill_unlock', 
                                studentId: student.id, 
                                amount: rewardCoins, 
                                xp: rewardXp, 
                                label: skill.name, 
                                title: 'æ–°æŠ€èƒ½è§£é”', 
                                theme: 'amber' 
                            }), 100);
                        }
                    }
                }

        async function handleCoinEdit() {
            const student = getStudent(state.selectedStudentId);
            const amount = parseInt(document.getElementById('edit-coin-amount').value);
            const reason = document.getElementById('edit-coin-reason').value.trim() || "è€å¸ˆè°ƒæ•´";
            if (isNaN(amount) || amount === 0) return alert("æ— æ•ˆé‡‘é¢");
            closeModal();
            await modifyStudent(student, amount, reason, 0);
        }

        // --- UI Rendering ---
        
        function handleGlobalClick(e) {
            const d = document.getElementById('class-dropdown-container');
            if (d && !d.contains(e.target)) {
                state.isClassDropdownOpen = false;
                renderHeader();
            }
        }

        function toggleClassDropdown(e) {
            if (state.userRole === 'student') return; 
            if(e) e.stopPropagation();
            state.isClassDropdownOpen = !state.isClassDropdownOpen;
            renderHeader();
            lucide.createIcons();
        }

        function switchView(mode) {
            state.viewMode = mode;
            if (mode === 'manage') renderManageView(document.getElementById('main-container'));
            else renderAll();
        }

        function resetModalState() {
            state.isClassRewardMode = false;
            state.isSkillEditorMode = false;
            state.isTemplateManagerMode = false;
            state.isCoinEditMode = false;
            state.isAssignModalOpen = false;
            state.selectedStudentId = null;
            state.assignTargetStudentId = null;
        }

        function openStudentModal(id) {
            if (state.userRole === 'student') return; 
            resetModalState();
            state.selectedStudentId = id;
            state.popupTab = 'reward';
            renderModal();
        }

        function openClassRewardModal() {
            resetModalState();
            state.isClassRewardMode = true;
            renderModal();
        }

        function openCoinEditModal(id) {
            resetModalState();
            state.selectedStudentId = id;
            state.isCoinEditMode = true;
            renderModal();
        }

        function closeModal() {
            resetModalState();
            document.getElementById('modal-overlay').classList.add('hidden');
        }

        function renderAll() {
                    let scrollPos = 0;
                    const scrollContainer = document.getElementById('profile-content-area');
                    if (scrollContainer) {
                        scrollPos = scrollContainer.scrollTop;
                    }
        
                    renderHeader();
                    renderMain();
                    lucide.createIcons();
        
                    if (state.viewMode === 'profile' && scrollPos > 0) {
                        setTimeout(() => {
                            const newContainer = document.getElementById('profile-content-area');
                            if (newContainer) {
                                newContainer.scrollTop = scrollPos;
                            }
                        }, 0);
                    }
                }

        function renderHeader() {
            if(state.userRole === 'student') {
                document.getElementById('teacher-controls').classList.add('hidden');
                document.getElementById('student-controls').classList.remove('hidden');
                document.getElementById('class-dropdown-container').classList.add('hidden');
                document.getElementById('student-header-title').classList.remove('hidden');
                document.getElementById('teacher-logout-btn').classList.add('hidden');
                return;
            }

            document.getElementById('teacher-controls').classList.remove('hidden');
            document.getElementById('student-controls').classList.add('hidden');
            document.getElementById('class-dropdown-container').classList.remove('hidden');
            document.getElementById('student-header-title').classList.add('hidden');
            document.getElementById('teacher-logout-btn').classList.remove('hidden');

            const currentClass = getCurrentClass();
            document.getElementById('current-class-name').textContent = currentClass ? currentClass.name : "è¯·åˆ›å»ºç­çº§";
            
            const listContainer = document.getElementById('class-list-container');
            if(state.classes.length === 0) {
                listContainer.innerHTML = '<div class="p-4 text-slate-500 text-sm text-center">æš‚æ— ç­çº§</div>';
            } else {
                listContainer.innerHTML = state.classes.map(c => `
                    <div onclick="handleSwitchClass('${c.id}')" class="w-full text-left px-6 py-4 hover:bg-slate-700 flex justify-between items-center cursor-pointer ${state.currentClassId === c.id ? 'bg-indigo-900/50 text-indigo-300' : ''}">
                        <span class="font-bold truncate">${c.name}</span>
                        <button onclick="handleDeleteClass(event, '${c.id}')" class="p-1 hover:text-red-400 z-10 rounded hover:bg-slate-600 transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>
                `).join('');
            }

            const dropdown = document.getElementById('class-dropdown-menu');
            if (state.isClassDropdownOpen) dropdown.classList.remove('hidden');
            else dropdown.classList.add('hidden');

            ['grid', 'rank', 'manage', 'profile'].forEach(mode => {
                const btn = document.getElementById(`btn-view-${mode}`);
                if (btn) {
                    btn.className = `p-2 md:px-5 md:py-2 rounded-lg font-bold transition-all flex items-center gap-2 ${state.viewMode === mode ? (mode==='grid'?'bg-slate-700 text-white shadow-inner':(mode==='rank'?'bg-amber-600/20 text-amber-400 shadow-inner ring-1 ring-amber-500/50':(mode==='profile'?'bg-cyan-900/40 text-cyan-400 border border-cyan-500/30':'bg-slate-700 text-white'))) : 'text-slate-400 hover:bg-slate-800'}`;
                }
            });
        }

        function renderMain() {
            const container = document.getElementById('main-container');
            container.innerHTML = '';
            
            if (state.userRole === 'student') {
                if(state.viewMode !== 'profile') state.viewMode = 'profile'; 
                renderProfileView(container);
                return;
            }

            if (state.classes.length === 0 && state.viewMode !== 'manage') {
                container.innerHTML = `<div class="h-full flex flex-col items-center justify-center text-slate-500 gap-4"><i data-lucide="school" class="w-20 h-20 opacity-20"></i><p>è¯·å…ˆåœ¨ç®¡ç†é¡µé¢åˆ›å»ºç­çº§</p><button onclick="switchView('manage')" class="text-indigo-400 hover:underline">å»åˆ›å»º</button></div>`;
                return;
            }
            if (state.viewMode === 'grid') renderGridView(container);
            else if (state.viewMode === 'rank') renderRankView(container);
            else if (state.viewMode === 'manage') renderManageView(container);
            else if (state.viewMode === 'profile') renderProfileView(container);
        }

        function renderGridView(container) {
            if (state.students.length === 0) {
                container.innerHTML = `<div class="h-full flex flex-col items-center justify-center text-slate-500 gap-4"><i data-lucide="users" class="w-20 h-20 opacity-20"></i><p>è¿˜æ²¡æœ‰å­¦ç”Ÿï¼Œå»æ·»åŠ å§</p><button onclick="switchView('manage')" class="text-indigo-400 hover:underline">æ·»åŠ å­¦ç”Ÿ</button></div>`;
                return;
            }
            const sorted = [...state.students].sort((a,b) => b.coins - a.coins);
            let html = `<div class="h-full overflow-y-auto custom-scrollbar pr-2"><div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-3 md:gap-4 pb-20 md:pb-0">`;
            html += state.students.map(s => {
                const rank = sorted.findIndex(st => st.id === s.id);
                let crown = rank < 3 ? `<div class="absolute top-2 right-2"><i data-lucide="crown" class="w-5 h-5 ${rank === 0 ? 'text-yellow-400' : (rank === 1 ? 'text-slate-300' : 'text-amber-700')}"></i></div>` : '';
                const requiredXp = getRequiredXp(s.level);
                const xpPercent = Math.min(100, (s.xp / requiredXp) * 100);
                const today = new Date().toDateString();
                const isCheckedIn = s.lastCheckIn === today;
                const checkInBtn = isCheckedIn
                    ? `<div class="absolute top-2 left-2 bg-green-500 text-white text-[10px] px-2 py-0.5 rounded-full font-bold shadow-md flex items-center gap-1 cursor-default"><i data-lucide="check" class="w-3 h-3"></i> å·²ç­¾åˆ°</div>`
                    : `<button onclick="checkIn(event, '${s.id}')" class="absolute top-2 left-2 bg-slate-600 hover:bg-green-500 text-slate-200 hover:text-white text-[10px] px-2 py-0.5 rounded-full font-bold shadow-md transition-colors flex items-center gap-1 z-10"><i data-lucide="user-check" class="w-3 h-3"></i> ç­¾åˆ°</button>`;

                return `
                    <div onclick="openStudentModal('${s.id}')" class="group relative bg-slate-800/50 rounded-2xl p-4 pt-8 border border-slate-700 hover:border-indigo-500 hover:bg-slate-800 hover:shadow-xl hover:-translate-y-1 transition-all flex flex-col items-center gap-3 overflow-hidden cursor-pointer">
                        ${checkInBtn}${crown}
                        <div class="w-16 h-16 md:w-20 md:h-20 rounded-full bg-slate-700 flex items-center justify-center text-3xl md:text-4xl shadow-inner border-2 border-slate-600 group-hover:border-indigo-400 relative group-hover:scale-110 transition-transform">
                            ${s.avatar}
                            <div class="absolute -bottom-2 bg-indigo-900 border border-indigo-500 text-indigo-300 text-[10px] px-1.5 rounded text-center shadow font-bold leading-tight">Lv.${s.level}</div>
                        </div>
                        <div class="text-center w-full mt-1">
                            <h3 class="text-base md:text-lg font-bold text-slate-100 truncate w-full">${s.name}</h3>
                            <div class="flex items-center justify-center gap-1 mt-1 text-yellow-500 font-mono font-bold"><span class="text-xs">$</span>${s.coins}</div>
                            <div class="w-full bg-slate-700 h-1.5 rounded-full mt-2 overflow-hidden"><div class="bg-indigo-500 h-full rounded-full transition-all duration-500" style="width: ${xpPercent}%"></div></div>
                        </div>
                    </div>`;
            }).join('');
            html += `</div></div>`;
            container.innerHTML = html;
        }

        function renderRankView(container) {
            if (state.students.length === 0) {
                 container.innerHTML = `<div class="h-full flex items-center justify-center text-slate-500">æš‚æ— æ•°æ®</div>`;
                 return;
            }
            const sorted = [...state.students].sort((a,b) => b.coins - a.coins);
            let html = `<div class="max-w-4xl mx-auto bg-slate-800 rounded-2xl border border-slate-700 overflow-hidden shadow-2xl flex flex-col max-h-full">
                <div class="p-4 bg-slate-800/80 border-b border-slate-700 grid grid-cols-12 gap-2 md:gap-4 font-bold text-slate-400 text-xs md:text-sm uppercase tracking-wider text-center shrink-0">
                    <div class="col-span-2">æ’å</div><div class="col-span-5 text-left pl-2 md:pl-4">å­¦ç”Ÿ</div><div class="col-span-2">ç­‰çº§</div><div class="col-span-3">é‡‘å¸</div>
                </div>
                <div class="overflow-y-auto custom-scrollbar flex-1 pb-20 md:pb-0">`;
            
            html += sorted.map((s, i) => {
                let rankClass = i < 3 ? `bg-gradient-to-r ${i===0?'from-yellow-500/20 to-transparent border-l-4 border-yellow-500':(i===1?'from-slate-300/20 to-transparent border-l-4 border-slate-300':'from-amber-700/20 to-transparent border-l-4 border-amber-700')}` : 'hover:bg-slate-700/30 border-l-4 border-transparent';
                let medal = i < 3 ? `<i data-lucide="medal" class="w-5 h-5 md:w-6 md:h-6 ${i===0?'text-yellow-400':(i===1?'text-slate-300':'text-amber-600')}"></i>` : `<span class="text-slate-500 font-mono font-bold">#${i+1}</span>`;
                return `
                <div class="grid grid-cols-12 gap-2 md:gap-4 p-3 md:p-4 items-center border-b border-slate-700/50 ${rankClass} transition-colors text-sm md:text-base">
                    <div class="col-span-2 flex justify-center">${medal}</div>
                    <div class="col-span-5 flex items-center gap-2 md:gap-3 pl-2 md:pl-4"><div class="text-xl md:text-2xl">${s.avatar}</div><div class="font-bold text-slate-200 truncate">${s.name}</div></div>
                    <div class="col-span-2 text-center"><span class="bg-indigo-900 text-indigo-300 px-1.5 py-0.5 md:px-2 md:py-1 rounded text-[10px] md:text-xs font-bold">Lv.${s.level}</span></div>
                    <div class="col-span-3 text-center font-mono font-bold text-yellow-500">${s.coins}</div>
                </div>`;
            }).join('');
            html += `</div></div>`;
            container.innerHTML = html;
        }

        function renderProfileView(container) {
            const student = state.students.find(s => s.id === state.currentProfileId) || state.students[0];
            if (!student) {
                container.innerHTML = `<div class="h-full flex items-center justify-center text-slate-500">è¯¥ç­çº§æš‚æ— å­¦ç”Ÿ</div>`;
                return;
            }
            state.currentProfileId = student.id; 
        
            const collections = student.collections || [];
            const unlocked = student.unlockedSkills || [];
            const mastered = student.masteredSkills || [];
            const requiredXp = getRequiredXp(student.level);
            const xpPercent = Math.min(100, (student.xp / requiredXp) * 100);
        
            // å·¦ä¾§å­¦ç”Ÿåˆ—è¡¨ (ä»…æ•™å¸ˆå¯è§)
            let listHtml = '';
            if (state.userRole === 'teacher') {
                listHtml = state.students.map(s => `
                    <button onclick="state.currentProfileId='${s.id}'; renderAll()" class="w-full p-2 md:p-3 rounded-xl flex items-center gap-3 transition-colors ${state.currentProfileId === s.id ? 'bg-cyan-900/40 border border-cyan-500/50' : 'hover:bg-slate-800 border border-transparent'}">
                        <div class="w-8 h-8 md:w-10 md:h-10 rounded-full bg-slate-700 flex items-center justify-center text-xl md:text-2xl relative shrink-0">
                            ${s.avatar}
                            <div class="absolute -top-1 -right-1 w-3 h-3 md:w-4 md:h-4 bg-indigo-600 rounded-full text-[8px] flex items-center justify-center text-white border border-slate-700">${s.level}</div>
                        </div>
                        <div class="text-left overflow-hidden">
                            <div class="font-bold truncate text-sm md:text-base ${state.currentProfileId === s.id ? 'text-cyan-300' : 'text-slate-300'}">${s.name}</div>
                            <div class="text-xs text-slate-500 font-mono">$${s.coins}</div>
                        </div>
                    </button>
                `).join('');
            } else {
                    listHtml = `
                    <div class="p-4 text-center text-slate-500">
                        <i data-lucide="user" class="w-12 h-12 mx-auto mb-2 opacity-50"></i>
                        <div class="text-sm">æˆ‘çš„æ¡£æ¡ˆ</div>
                        <div class="text-xs mt-1 text-slate-600">ID: ${student.studentId || 'æœªçŸ¥'}</div>
                    </div>
                    `;
            }
        
            let rightContentHtml = '';
            if (state.profileTab === 'skills') {
                // æ•™å¸ˆåˆ†å‘æŒ‰é’®
                const assignBtn = state.userRole === 'teacher' ? 
                    `<div class="flex justify-end mb-4"><button onclick="openAssignModal('${student.id}')" class="bg-green-600 hover:bg-green-500 text-white text-xs px-3 py-1.5 rounded-lg font-bold flex items-center gap-1 shadow-lg ml-auto"><i data-lucide="plus" class="w-3 h-3"></i> åˆ†å‘æ–°å›¾é‰´</button></div>` : '';
        
                let collectionsHtml = '';
                if (collections.length === 0) {
                    collectionsHtml = `<div class="text-center text-slate-500 py-10 bg-slate-800/30 rounded-2xl border border-slate-700/50">æš‚æ— å›¾é‰´ï¼Œè¯·è€å¸ˆåˆ†å‘ã€‚</div>`;
                } else {
                    // æ¸²æŸ“æ‰å¹³åŒ–çš„å›¾é‰´åˆ—è¡¨
                    collectionsHtml = collections.map((col, colIndex) => {
                        const totalSkills = col.skills ? col.skills.length : 0;
                        const masteredCount = col.skills ? col.skills.filter(s => mastered.includes(s.id)).length : 0;
                        
                        const delColBtn = state.userRole === 'teacher' ? 
                            `<button onclick="removeCollectionFromStudent('${student.id}', '${col.id}')" class="p-1.5 text-slate-500 hover:text-red-400 hover:bg-slate-700/50 rounded-lg transition-colors ml-1" title="ç§»é™¤æ­¤å›¾é‰´"><i data-lucide="trash-2" class="w-4 h-4"></i></button>` 
                            : '';
        
                        // æ’åºæŒ‰é’®
                        let sortBtns = '';
                        if (collections.length > 1) {
                            const upBtn = colIndex > 0 
                                ? `<button onclick="moveCollection('${student.id}', ${colIndex}, -1)" class="p-1.5 text-slate-400 hover:text-white hover:bg-slate-700/50 rounded-lg" title="ä¸Šç§»"><i data-lucide="arrow-up" class="w-4 h-4"></i></button>`
                                : `<div class="w-7"></div>`;
                            
                            const downBtn = colIndex < collections.length - 1
                                ? `<button onclick="moveCollection('${student.id}', ${colIndex}, 1)" class="p-1.5 text-slate-400 hover:text-white hover:bg-slate-700/50 rounded-lg" title="ä¸‹ç§»"><i data-lucide="arrow-down" class="w-4 h-4"></i></button>`
                                : `<div class="w-7"></div>`;
                            
                            sortBtns = `<div class="flex items-center gap-0.5 mr-2 border-r border-slate-700 pr-2">${upBtn}${downBtn}</div>`;
                        }
        
                        const skillsHtml = (col.skills || []).map((skill, idx) => {
                            const isUnlocked = unlocked.includes(skill.id);
                            const isMastered = mastered.includes(skill.id);
                            const sReward = skill.coins || SKILL_REWARD;
                            let statusIcon, statusClass;
                            if(isMastered) {
                                statusIcon = 'check-check'; statusClass = 'bg-cyan-900/50 text-cyan-400 border-cyan-500/50';
                            } else if(isUnlocked) {
                                statusIcon = 'hourglass'; statusClass = 'bg-amber-900/50 text-amber-400 border-amber-500/50 animate-pulse-glow cursor-pointer';
                            } else {
                                statusIcon = 'lock'; statusClass = 'bg-slate-800 text-slate-600 border-slate-700 cursor-pointer hover:border-slate-500';
                            }
                            const isTeacher = state.userRole === 'teacher';
                            // ä¼ é€’çš„ç¬¬ä¸‰ä¸ªå‚æ•°ç°åœ¨æ˜¯ col.id (å›¾é‰´ID)ï¼Œå› ä¸ºä¸å†æœ‰ collection åˆ†æ”¯æ¦‚å¿µ
                            const clickAction = (isTeacher && !isMastered) ? `onclick="unlockSkill('${student.id}', '${skill.id}', '${col.id}')"` : (isTeacher ? '' : 'style="cursor: default"');
                            if (!isTeacher && !isMastered && !isUnlocked) statusClass = 'bg-slate-800 text-slate-600 border-slate-700 opacity-60';
        
                            return `
                                <div ${clickAction} class="flex flex-col items-center p-2 md:p-3 rounded-xl border ${statusClass} transition-all relative group h-24 justify-center">
                                    <div class="mb-1"><i data-lucide="${statusIcon}" class="w-5 h-5 md:w-6 md:h-6"></i></div>
                                    <div class="text-[10px] md:text-xs font-bold text-center leading-tight mb-1 line-clamp-2">${skill.name}</div>
                                    ${!isMastered ? `<div class="text-[9px] md:text-[10px] bg-slate-900/50 px-1 md:px-1.5 py-0.5 rounded text-slate-400">+${sReward}</div>` : ''}
                                </div>
                            `;
                        }).join('');
        
                        return `
                            <div class="mb-4 md:mb-6 bg-slate-800/50 border border-slate-700 rounded-2xl overflow-hidden transition-all duration-300">
                                <div class="p-3 md:p-4 bg-slate-800 border-b border-slate-700 flex justify-between items-center">
                                    <div class="overflow-hidden mr-2 flex-1">
                                        <div class="flex items-center gap-2">
                                            <h3 class="font-bold text-base md:text-lg text-slate-200 truncate">${col.name}</h3>
                                        </div>
                                        <div class="text-[10px] md:text-xs text-slate-500 mt-1 truncate">å¥–åŠ±: <span class="text-yellow-500 font-mono">+${col.bonusCoins || 500}</span> <span class="text-purple-400 font-mono">+${col.bonusXp || 200}XP</span></div>
                                    </div>
                                    <div class="text-right shrink-0 flex items-center">
                                        ${sortBtns}
                                        <div class="text-xl md:text-2xl font-black text-slate-600 font-mono mr-2">${masteredCount}<span class="text-xs md:text-sm text-slate-600">/${totalSkills}</span></div>
                                        ${delColBtn}
                                    </div>
                                </div>
                                <div class="p-3 md:p-4">
                                    <div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-2 md:gap-3">${skillsHtml}</div>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
        
                rightContentHtml = `<div class="max-w-3xl mx-auto md:pl-4 pb-20">${assignBtn}${collectionsHtml}</div>`;
            } else {
                const historyHtml = (student.history && student.history.length > 0) ? student.history.map(h => `
                    <div class="flex items-center justify-between p-3 md:p-4 bg-slate-800/50 rounded-xl border border-slate-700">
                        <div class="flex items-center gap-3 md:gap-4 overflow-hidden mr-2">
                            <div class="w-8 h-8 md:w-10 md:h-10 rounded-full flex items-center justify-center shrink-0 ${h.amount > 0 ? 'bg-green-900/30 text-green-400' : 'bg-red-900/30 text-red-400'}"><i data-lucide="${h.amount > 0 ? 'plus' : 'minus'}" class="w-4 h-4 md:w-5 md:h-5"></i></div>
                            <div class="overflow-hidden"><div class="font-bold text-white text-sm md:text-base truncate">${h.reason}</div><div class="text-xs text-slate-500">${h.date}</div></div>
                        </div>
                        <div class="text-right shrink-0"><div class="font-mono font-bold text-base md:text-lg ${h.amount > 0 ? 'text-green-400' : 'text-red-400'}">${h.amount > 0 ? '+' : ''}${h.amount}</div><div class="text-xs text-slate-500">ä½™é¢: ${h.balance}</div></div>
                    </div>`).join('') : `<div class="text-center text-slate-500 py-10">æš‚æ— è®°å½•</div>`;
                rightContentHtml = `<div class="space-y-2 pb-20">${historyHtml}</div>`;
            }
        
            const editBtn = state.userRole === 'teacher' ? `<button onclick="openCoinEditModal('${student.id}')" class="p-1.5 md:p-2 rounded-lg bg-slate-700 hover:bg-slate-600 text-slate-300 transition-colors"><i data-lucide="pencil" class="w-4 h-4 md:w-5 md:h-5"></i></button>` : '';
        
            container.innerHTML = `
                <div class="h-full flex flex-col md:flex-row gap-4 md:gap-6 animate-in fade-in">
                    <div class="${state.userRole === 'student' ? 'hidden md:flex' : 'flex'} flex-col w-full md:w-64 bg-slate-800 rounded-2xl border border-slate-700 overflow-hidden shrink-0 h-48 md:h-auto">
                        <div class="p-3 md:p-4 bg-slate-800/80 border-b border-slate-700 font-bold text-slate-400 text-sm tracking-wider uppercase">å­¦ç”Ÿåˆ—è¡¨</div>
                        <div class="flex-1 overflow-y-auto p-2 space-y-1 custom-scrollbar">${listHtml}</div>
                    </div>
                    <div class="flex-1 flex flex-col gap-4 md:gap-6 overflow-hidden">
                        <div class="bg-gradient-to-r from-slate-800 to-slate-800/50 p-4 md:p-6 rounded-2xl border border-slate-700 flex items-center justify-between shadow-lg relative overflow-hidden shrink-0">
                            <div class="flex items-center gap-4 md:gap-6 relative z-10">
                                <div class="w-16 h-16 md:w-24 md:h-24 rounded-full bg-slate-700 border-4 border-slate-600 flex items-center justify-center text-4xl md:text-6xl shadow-xl shrink-0">${student.avatar}</div>
                                <div class="overflow-hidden">
                                    <div class="flex items-center gap-2 md:gap-3 mb-1 md:mb-2">
                                        <h1 class="text-2xl md:text-4xl font-black text-white truncate max-w-[150px] md:max-w-xs">${student.name}</h1>
                                        <div class="bg-indigo-600 px-2 py-0.5 md:px-3 md:py-1 rounded-lg text-white font-bold text-xs md:text-lg shadow border border-indigo-400 shrink-0">Lv.${student.level}</div>
                                    </div>
                                    <div class="w-32 md:w-64">
                                        <div class="flex justify-between text-xs text-indigo-300 mb-1 font-bold"><span>XP</span><span>${student.xp} / ${requiredXp}</span></div>
                                        <div class="w-full bg-slate-900 h-2 md:h-3 rounded-full overflow-hidden border border-slate-600"><div class="bg-gradient-to-r from-indigo-500 to-purple-500 h-full rounded-full transition-all duration-500 shadow-[0_0_10px_rgba(99,102,241,0.5)]" style="width: ${xpPercent}%"></div></div>
                                    </div>
                                </div>
                            </div>
                            <div class="text-right relative z-10 pl-2">
                                <div class="text-xs md:text-sm text-slate-400 font-bold uppercase tracking-widest mb-1">é‡‘å¸ä½™é¢</div>
                                <div class="flex items-center justify-end gap-2 md:gap-3">
                                    <div class="text-3xl md:text-6xl font-mono font-black text-yellow-400 drop-shadow-md flex items-center gap-1 md:gap-2"><i data-lucide="coins" class="w-6 h-6 md:w-10 md:h-10 text-yellow-500"></i> ${student.coins}</div>
                                    ${editBtn}
                                </div>
                            </div>
                        </div>
                        <div class="flex border-b border-slate-700 shrink-0 overflow-x-auto">
                            <button onclick="state.profileTab='skills'; renderAll()" class="px-4 md:px-6 py-2 md:py-3 font-bold transition-colors border-b-2 whitespace-nowrap ${state.profileTab === 'skills' ? 'text-cyan-400 border-cyan-500' : 'text-slate-500 border-transparent hover:text-slate-300'}"><i data-lucide="network" class="w-4 h-4 inline mr-2"></i> æŠ€èƒ½å›¾é‰´</button>
                            <button onclick="state.profileTab='history'; renderAll()" class="px-4 md:px-6 py-2 md:py-3 font-bold transition-colors border-b-2 whitespace-nowrap ${state.profileTab === 'history' ? 'text-amber-400 border-amber-500' : 'text-slate-500 border-transparent hover:text-slate-300'}"><i data-lucide="scroll-text" class="w-4 h-4 inline mr-2"></i> å˜åŠ¨è®°å½•</button>
                        </div>
                        <div id="profile-content-area" class="flex-1 bg-slate-800/30 rounded-b-2xl border-x border-b border-slate-700/50 p-4 md:p-8 overflow-y-auto custom-scrollbar relative">${rightContentHtml}</div>
                    </div>
                </div>`;
        }

        function renderManageView(container) {
            if (state.userRole !== 'teacher') return;
            const currentClass = getCurrentClass();
            const classList = state.classes.map(c => `
                <div onclick="handleSwitchClass('${c.id}')" class="p-3 md:p-4 rounded-xl cursor-pointer border flex justify-between items-center group transition-all ${state.currentClassId === c.id ? 'bg-indigo-600 border-indigo-500 shadow-lg' : 'bg-slate-700/50 border-transparent hover:bg-slate-700'}">
                    <div><div class="font-bold text-sm md:text-base">${c.name}</div></div>
                </div>`).join('');
            
            const studentList = state.students.map(s => `
                <div class="bg-slate-700/50 p-3 rounded-xl flex items-center gap-3 border border-transparent hover:border-slate-500 group relative">
                    <button onclick="handleUpdateStudent('${s.id}', 'avatar', AVATARS[(AVATARS.indexOf('${s.avatar}')+1)%AVATARS.length])" class="text-xl md:text-2xl w-8 h-8 md:w-10 md:h-10 bg-slate-600 rounded-full flex items-center justify-center hover:bg-slate-500 transition-colors shrink-0">${s.avatar}</button>
                    <div class="flex-1 min-w-0">
                        <input onblur="handleUpdateStudent('${s.id}', 'name', this.value)" type="text" value="${s.name}" class="bg-transparent border-b border-transparent focus:border-indigo-500 focus:outline-none w-full font-bold text-slate-200 placeholder-slate-500 text-sm md:text-base">
                        <div class="text-xs text-slate-500 font-mono mt-1">å­¦å·: ${s.studentId || 'æ— '}</div>
                    </div>
                    <button onclick="handleDeleteStudent(event, '${s.id}')" class="p-2 text-red-400 hover:bg-red-500/20 rounded-lg shrink-0"><i data-lucide="trash-2" class="w-4 h-4 md:w-5 md:h-5"></i></button>
                </div>`).join('');

            container.innerHTML = `
                <div class="h-full flex flex-col md:flex-row gap-4 md:gap-6 animate-in fade-in slide-in-from-bottom-4">
                    <div class="w-full md:w-1/3 bg-slate-800 rounded-2xl border border-slate-700 p-4 flex flex-col h-48 md:h-auto shrink-0">
                        <h2 class="text-lg font-bold text-slate-400 mb-2 md:mb-4 px-2 uppercase tracking-wider">æˆ‘çš„ç­çº§</h2>
                        <div class="flex-1 overflow-y-auto space-y-2 mb-2 md:mb-4 custom-scrollbar">${classList}</div>
                        <div class="flex gap-2 pt-2 md:pt-4 border-t border-slate-700 mb-2 md:mb-4"><input type="text" id="new-class-input" placeholder="æ–°ç­çº§..." class="flex-1 bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-sm text-white"><button onclick="handleAddClass()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-bold text-sm shrink-0">æ·»åŠ </button></div>
                        <button onclick="openTemplateLibrary()" class="w-full py-3 bg-cyan-900/30 hover:bg-cyan-900/50 text-cyan-400 border border-cyan-500/30 rounded-xl flex items-center justify-center gap-2 font-bold transition-all"><i data-lucide="library" class="w-5 h-5"></i> ç®¡ç†å›¾é‰´åº“</button>
                    </div>
                    <div class="flex-1 bg-slate-800 rounded-2xl border border-slate-700 p-4 md:p-6 flex flex-col min-h-0">
                        <div class="flex justify-between items-center mb-4 md:mb-6"><h2 class="text-xl md:text-2xl font-bold truncate pr-4">${currentClass ? currentClass.name : ''} <span class="text-slate-500 text-base font-normal hidden sm:inline">| å­¦ç”Ÿåå•</span></h2><button onclick="handleAddStudent()" class="bg-indigo-600 hover:bg-indigo-500 text-white px-3 py-1.5 md:px-4 md:py-2 rounded-lg flex items-center gap-2 font-bold shadow-lg shadow-indigo-500/20 text-sm md:text-base shrink-0"><i data-lucide="user-plus" class="w-4 h-4 md:w-5 md:h-5"></i> æ·»åŠ å­¦ç”Ÿ</button></div>
                        <div class="flex-1 overflow-y-auto grid grid-cols-1 sm:grid-cols-2 md:grid-cols-2 lg:grid-cols-3 gap-3 content-start custom-scrollbar pb-20 md:pb-0">${studentList}</div>
                    </div>
                </div>`;
        }

        // --- Animations ---
        function playAnimation(data) {
            const layer = document.getElementById('animation-layer');
            layer.classList.remove('hidden');
            let html = '';
            
            // 1. å•äººé‡‘å¸å¥–åŠ±/æ‰£é™¤
            if (data.type === 'single_reward') {
                const student = getStudent(data.studentId);
                const isNegative = data.amount < 0;
                const borderColor = isNegative ? 'border-red-500' : 'border-yellow-400';
                const textColor = isNegative ? 'text-red-500' : 'text-yellow-500';
                const icon = isNegative ? 'ğŸ’”' : (data.label === 'ä¿®å¤Bug' ? 'ğŸ›' : 'â­');
                const sign = data.amount > 0 ? '+' : '';
                const xpBadge = isNegative ? `<span class="text-sm bg-red-100 text-red-800 px-2 rounded ml-2">-1 XP</span>` : (data.amount !== 0 ? `<span class="text-sm bg-indigo-100 text-indigo-800 px-2 rounded ml-2">+1 XP</span>` : '');

                html = `<div class="bg-white/95 text-slate-900 p-12 rounded-3xl shadow-2xl border-8 ${borderColor} animate-bounce-in text-center transform scale-110">
                    <div class="text-6xl mb-4">${icon}</div>
                    <div class="text-4xl font-black mb-2">${student ? student.name : ''}</div>
                    <div class="text-2xl text-slate-500 font-bold mb-4">${data.label}</div>
                    <div class="text-8xl font-black ${textColor} flex items-center justify-center gap-2">
                        <span class="text-4xl">${sign}</span>${data.amount} ${xpBadge}
                    </div>
                </div>`;
            } 
            // 2. è·å¾—æ–°å›¾é‰´
            else if (data.type === 'new_collection') {
                const student = getStudent(data.studentId);
                html = `<div class="bg-white/95 text-slate-900 p-12 rounded-3xl shadow-2xl border-8 border-cyan-500 animate-bounce-in text-center transform scale-110">
                    <div class="text-6xl mb-6 text-cyan-500 animate-pulse"><i data-lucide="book-open" class="w-24 h-24 mx-auto"></i></div>
                    <div class="text-4xl font-black mb-2">${student ? student.name : ''}</div>
                    <div class="text-xl text-slate-400 font-bold mb-4 uppercase tracking-widest">New Collection</div>
                    <div class="text-3xl font-black text-cyan-600 mb-2">å·²è·å¾—æ–°å›¾é‰´</div>
                    <div class="bg-cyan-100 text-cyan-800 px-4 py-2 rounded-xl font-bold text-lg inline-block shadow-sm">
                        ${data.label}
                    </div>
                </div>`;
            }
            // 3. å…¨ç­å¥–åŠ±
            else if (data.type === 'class_reward') {
                html = `<div class="relative"><div class="absolute inset-0 flex items-center justify-center"><div class="w-[500px] h-[500px] bg-gradient-to-r from-pink-500/30 to-purple-500/30 blur-[100px] rounded-full animate-pulse"></div></div><div class="bg-gradient-to-br from-indigo-600 to-purple-700 text-white p-16 rounded-[3rem] shadow-[0_0_60px_rgba(139,92,246,0.6)] border-4 border-white/20 animate-bounce-in text-center transform scale-110 relative overflow-hidden"><div class="relative z-10"><div class="text-7xl mb-6 flex justify-center gap-4 animate-bounce">âš¡ ğŸš€ âš¡</div><div class="text-6xl font-black mb-4 drop-shadow-md">å…¨ç­ ${data.label}</div><div class="text-9xl font-black text-yellow-300 flex items-center justify-center gap-2 drop-shadow-[0_4px_0_rgba(0,0,0,0.5)]"><span class="text-5xl">+</span>${data.amount} <span class="text-xl bg-white/20 px-3 py-1 rounded-full">+1 XP</span></div></div></div></div>`;
            } 
            // 4. å…‘æ¢æˆåŠŸ
            else if (data.type === 'exchange') {
                html = `<div class="relative animate-bounce-in"><div class="bg-white text-slate-900 p-10 rounded-full shadow-[0_0_50px_rgba(255,255,255,0.5)] border-8 border-red-500 w-80 h-80 flex flex-col items-center justify-center relative overflow-hidden transform rotate-12"><div class="absolute inset-2 border-4 border-red-500 rounded-full border-dashed opacity-50"></div><div class="text-red-600 text-8xl mb-2 opacity-90"><i data-lucide="stamp" class="w-20 h-20"></i></div><h2 class="text-4xl font-black text-red-600 uppercase tracking-widest -rotate-6">å…‘æ¢æˆåŠŸ</h2><div class="mt-2 font-mono font-bold text-slate-400 line-through text-xl">${data.amount} é‡‘å¸</div></div></div>`;
            } 
            // 5. æŠ€èƒ½è§£é”
            else if (data.type === 'skill_unlock') {
                const isAmber = data.theme === 'amber';
                const colorClass = isAmber ? 'text-amber-300' : 'text-cyan-300';
                const bgClass = isAmber ? 'bg-amber-900' : 'bg-cyan-900';
                const borderClass = isAmber ? 'border-amber-400' : 'border-cyan-400';
                const titleText = data.title || 'æŠ€èƒ½æŒæ¡';
                const icon = isAmber ? 'lightbulb' : 'zap';
                html = `<div class="relative animate-bounce-in"><div class="${bgClass} text-white p-12 rounded-3xl shadow-[0_0_80px_rgba(255,255,255,0.2)] border-4 ${borderClass} text-center transform scale-110 overflow-hidden"><div class="absolute top-0 left-0 w-full h-full bg-gradient-to-r from-transparent via-white/20 to-transparent animate-shine"></div><div class="text-7xl mb-4 ${colorClass}"><i data-lucide="${icon}" class="w-24 h-24 fill-current mx-auto"></i></div><div class="text-3xl font-bold text-white mb-2 opacity-90">${titleText}</div><div class="text-5xl font-black mb-6">${data.label}</div><div class="text-6xl font-black text-yellow-400 drop-shadow-md">+${data.amount} <span class="text-3xl">é‡‘å¸</span></div><div class="mt-4 ${colorClass} font-bold text-2xl">+${data.xp || SKILL_XP} XP</div></div></div>`;
            } 
            // 6. å›¾é‰´é›†é½
            else if (data.type === 'collection_complete') {
                html = `<div class="relative animate-bounce-in"><div class="absolute inset-0 bg-gradient-to-r from-yellow-400/30 via-amber-500/30 to-purple-600/30 blur-[100px] rounded-full animate-pulse"></div><div class="bg-gradient-to-br from-purple-900 to-indigo-900 text-white p-14 rounded-[3rem] shadow-[0_0_80px_rgba(168,85,247,0.6)] border-4 border-yellow-400/50 text-center transform scale-110 relative overflow-hidden"><div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/stardust.png')] opacity-30"></div><div class="relative z-10"><div class="text-7xl mb-6 flex justify-center gap-4 animate-bounce">ğŸ† âœ¨ ğŸ†</div><div class="text-2xl font-bold text-yellow-300 mb-2 uppercase tracking-widest">Collection Completed</div><div class="text-5xl font-black mb-6 drop-shadow-md">${data.label} <br>é›†é½ï¼</div><div class="bg-white/10 rounded-2xl p-6 border border-white/10 backdrop-blur-sm"><div class="text-yellow-400 text-6xl font-black font-mono mb-2">+${data.amount} <span class="text-2xl">é‡‘å¸</span></div><div class="text-purple-300 text-2xl font-bold font-mono">å¤§å¥–å·²å‘æ”¾</div></div></div></div></div>`;
            } 
            // 7. ç­¾åˆ°
            else if (data.type === 'check_in') {
                html = `<div class="bg-white/95 text-slate-900 p-12 rounded-3xl shadow-2xl border-8 border-green-500 animate-bounce-in text-center transform scale-110"><div class="text-6xl mb-4 text-green-500"><i data-lucide="user-check" class="w-24 h-24 mx-auto"></i></div><div class="text-4xl font-black mb-2 text-slate-800">ç­¾åˆ°æˆåŠŸ</div><div class="text-6xl font-black text-yellow-500 flex items-center justify-center gap-2 mb-2"><span class="text-4xl">+</span>${data.amount} <span class="text-2xl text-slate-400">é‡‘å¸</span></div><div class="text-2xl font-bold text-indigo-500 bg-indigo-50 inline-block px-4 py-1 rounded-full">+${ATTENDANCE_XP} XP</div></div>`;
            } 
            // 8. å‡çº§
            else if (data.type === 'level_up') {
                html = `<div class="relative animate-bounce-in"><div class="absolute inset-0 bg-gradient-to-r from-yellow-400 via-orange-500 to-red-500 rounded-full blur-3xl opacity-50 animate-pulse"></div><div class="bg-slate-900 p-12 rounded-[3rem] border-8 border-yellow-400 text-center relative z-10 shadow-[0_0_100px_rgba(250,204,21,0.5)] overflow-hidden"><div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/stardust.png')] opacity-50"></div><div class="animate-burst absolute inset-0 border-4 border-white rounded-full opacity-0"></div><div class="text-8xl mb-6 animate-bounce">ğŸ†™</div><div class="text-6xl font-black text-white italic tracking-tighter mb-2" style="text-shadow: 4px 4px 0 #d97706">LEVEL UP!</div><div class="text-9xl font-black text-transparent bg-clip-text bg-gradient-to-b from-yellow-300 to-yellow-600">${data.level}</div><div class="text-xl text-yellow-200 mt-4 font-bold tracking-widest uppercase">New Level Reached</div></div></div>`;
            }
            
            layer.innerHTML = html;
            lucide.createIcons();
            setTimeout(() => { layer.innerHTML = ''; layer.classList.add('hidden'); }, 3500);
        }
        bootstrap();
    </script>
</body>
</html>